<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toonie</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/192.png" type="image/png" sizes="192x192">
  <link rel="icon" href="icons/512.png" type="image/png" sizes="512x512">

  <meta name="theme-color" content="#0f0f0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Toonie">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    :root{
      --boot-min-show: 3500ms;
      --boot-fade: 1200ms;
      --app-fade: 700ms;
      --app-fade-delay: 150ms;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0f0f0f;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
    }

    #app {
      opacity: 0;
      transform: scale(0.985);
      transition:
        opacity var(--app-fade) ease var(--app-fade-delay),
        transform var(--app-fade) ease var(--app-fade-delay);
      padding-bottom: 3rem;
    }
    .boot-done #app { opacity: 1; transform: scale(1); }

    .heading {
      font-size: 2rem;
      margin: 2rem auto;
      text-align: center;
      line-height: 1.4;
      width: 100%;
      background: linear-gradient(90deg, #facc15, #00f0ff, #facc15);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 3s linear infinite;
    }
    @keyframes shine { 0% {background-position:0% center;} 100% {background-position:-200% center;} }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      width: 100%;
      max-width: 600px;
      padding: 0 2rem 2rem;
      box-sizing: border-box;
      margin: 0 auto;
    }

    .section-gap { margin-top: 1.5rem; }

    a {
      display: block;
  background: rgba(30,30,30,0.92);
  border: 1px solid rgba(255,255,255,0.08);
  padding: 0.75rem 1rem;
  text-align: center;
  border-radius: 100px;
  text-decoration: none;
  position: relative;
  overflow: hidden;
  transition:
    transform 160ms cubic-bezier(.2,.9,.2,1),
    box-shadow 160ms cubic-bezier(.2,.9,.2,1),
    filter 160ms ease,
    background-color 200ms ease;
  -webkit-tap-highlight-color: transparent;
  color: inherit;
  transform: translateZ(0);
  box-shadow:
    0 10px 22px rgba(0,0,0,0.45),
    0 2px 0 rgba(255,255,255,0.05) inset;
    }

    a span.label {
      display: inline-block;
      background: linear-gradient(90deg, #facc15, #00f0ff, #facc15);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 3s linear infinite;
    }

    a span.ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 3.5s linear;
      background-color: rgba(0, 240, 255, 0.3);
      pointer-events: none;
    }
    @keyframes ripple { to { transform: scale(4); opacity: 0; } }

    a:active{
  transform: translateY(1px) scale(0.985);
  box-shadow:
    0 8px 18px rgba(0,0,0,0.42),
    0 1px 0 rgba(255,255,255,0.04) inset;
  filter: brightness(1.06);
}
a:hover{
  transform: translateY(-2px) scale(1.01);
  box-shadow:
    0 14px 28px rgba(0,0,0,0.52),
    0 2px 0 rgba(255,255,255,0.06) inset;
}

a::before{
  content:"";
  position:absolute;
  inset: 0;
  pointer-events:none;
  background: radial-gradient(120px 80px at 25% 15%, rgba(255,255,255,0.10), transparent 60%);
  opacity: 0.9;
}

a::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius: 100px;
  pointer-events:none;
  border: 2px solid rgba(0,240,255,0.08);
  opacity: 0;
  transform: scale(0.98);
  transition: opacity 200ms ease, transform 200ms ease;
}

a:hover::after{
  opacity: 1;
  transform: scale(1);
}

@media (prefers-reduced-motion: reduce){
  a{ transition:none; }
  a:hover{ transform:none; }
}


    .movies-row {
      grid-column: span 2;
      background-color: #1e1e1e;
      border-radius: 100px;
      overflow: hidden;
      display: flex;
    }
    .movies-row a { flex: 1; border-radius: 0; background: transparent; }
    .movies-row a:first-child { border-right: 1px solid #333; }

    #boot {
      position: fixed;
      inset: 0;
      background: #0f0f0f;
      z-index: 9999;
      opacity: 1;
      transition: opacity var(--boot-fade) ease;
    }
    #boot.hide { opacity: 0; pointer-events: none; }

    @media (prefers-reduced-motion: reduce) {
      #boot { transition: none; }
      #app { transition: none; }
    }

    /* ===== Progress Tracker ===== */
    .tools-wrap{
      width: 100%;
      max-width: 760px;
      margin: 0 auto 3rem;
      padding: 0 2rem;
      box-sizing: border-box;
    }

    .tool-card{
      background: rgba(30,30,30,0.75);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 18px;
      padding: 1.25rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-top: 1rem;
    }

    .tool-title{
      font-size: 1.15rem;
      margin: 0 0 0.75rem 0;
      background: linear-gradient(90deg, #facc15, #00f0ff, #facc15);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine 3s linear infinite;
    }

    .tool-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8rem;
      align-items: end;
    }
    @media (max-width: 640px){
      .tool-row{ grid-template-columns: 1fr; }
    }

    .tool-field{
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .tool-label{
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .tool-input, .tool-select{
      width: 100%;
      background: #151515;
      border: 1px solid #2a2a2a;
      color: #fff;
      border-radius: 12px;
      padding: 0.7rem 0.8rem;
      outline: none;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    .tool-input:focus, .tool-select:focus{
      border-color: rgba(0,240,255,0.6);
      box-shadow: 0 0 0 3px rgba(0,240,255,0.12);
    }

    .seg{
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .seg button{
      background: #151515;
      border: 1px solid #2a2a2a;
      color: #fff;
      border-radius: 999px;
      padding: 0.55rem 0.9rem;
      cursor: pointer;
      transition: transform 0.15s ease, background-color 0.2s ease, border-color 0.2s ease;
    }
    .seg button:active{ transform: scale(0.98); }
    .seg button.active{
      border-color: rgba(0,240,255,0.65);
      background: rgba(0,240,255,0.08);
    }

    .tool-mini{
      font-size: 0.92rem;
      opacity: 0.9;
      margin-top: 0.8rem;
      line-height: 1.4;
    }

    .save-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8rem;
      margin-top: 0.8rem;
    }
    @media (max-width: 640px){
      .save-row{ grid-template-columns: 1fr; }
    }

    .save-btn{
      width: 100%;
      background: #1e1e1e;
      border: 1px solid #2a2a2a;
      color: #fff;
      border-radius: 14px;
      padding: 0.75rem 0.95rem;
      cursor: pointer;
      transition: transform 0.15s ease, background-color 0.2s ease, border-color 0.2s ease;
    }
    .save-btn:active{ transform: scale(0.98); background-color: #2a2a2a; }

    .activity-list{
      margin-top: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      max-height: 320px;
      overflow: auto;
      padding-right: 0.25rem;
    }

    .activity-item{
      background: rgba(21,21,21,0.9);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 0.75rem 0.85rem;
      font-size: 0.95rem;
      line-height: 1.35;
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
    }
    .activity-item .right{
      opacity: 0.75;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    .hidden{ display: none !important; }

  /* ===== ALL-IN FX LAYERS ===== */
#fxCanvas{
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  z-index: -3;
  pointer-events: none;
  opacity: 0.95;
}

#cursorGlow{
  position: fixed;
  width: 520px;
  height: 520px;
  left: 50%;
  top: 50%;
  transform: translate(-50%,-50%);
  border-radius: 50%;
  pointer-events: none;
  z-index: -2;
  background: radial-gradient(circle, rgba(0,240,255,0.20), rgba(250,204,21,0.10), transparent 60%);
  filter: blur(22px);
  mix-blend-mode: screen;
  opacity: 0.85;
  transition: opacity 0.25s ease;
}

/* optional: when user is inactive, reduce intensity */
.fx-idle #cursorGlow{ opacity: 0.45; }

    
  </style>
</head>

<body>
  <canvas id="fxCanvas"></canvas>
<div id="cursorGlow"></div>

  <div id="boot"></div>

  <main id="app">
    <h1 class="heading">DM All<br />Seasons & Movies</h1>
    <div class="grid">
      <a href="https://archive.org/details/dm-s1-mak" onclick="ripple(event)"><span class="label">DM_S1</span></a>
      <a href="https://archive.org/details/doraemon-s2-mak" onclick="ripple(event)"><span class="label">DM_S2</span></a>
      <a href="https://archive.org/details/DM-S3-MAK" onclick="ripple(event)"><span class="label">DM_S3</span></a>
      <a href="https://archive.org/details/DM-S4-MAK" onclick="ripple(event)"><span class="label">DM_S4</span></a>
      <a href="https://archive.org/details/DM-S5-MAK" onclick="ripple(event)"><span class="label">DM_S5</span></a>
      <a href="https://archive.org/details/DM-S6-MAK2" onclick="ripple(event)"><span class="label">DM_S6</span></a>
      <a href="https://archive.org/details/DM-S7-MAK" onclick="ripple(event)"><span class="label">DM_S7</span></a>
      <a href="https://archive.org/details/DM-S8-MAK" onclick="ripple(event)"><span class="label">DM_S8</span></a>
      <a href="https://archive.org/details/DM-S12-MAK" onclick="ripple(event)"><span class="label">DM_S12</span></a>
      <a href="https://archive.org/details/DM_S14_MAK" onclick="ripple(event)"><span class="label">DM_S14</span></a>
      <a href="https://archive.org/details/DM_S15_MAK" onclick="ripple(event)"><span class="label">DM_S15</span></a>
      <a href="https://archive.org/details/DM_S16_MAK" onclick="ripple(event)"><span class="label">DM_S16</span></a>
      <a href="https://archive.org/details/DM_S17_MAK" onclick="ripple(event)"><span class="label">DM_S17</span></a>
      <a href="https://archive.org/details/DM_S18_MAK" onclick="ripple(event)"><span class="label">DM_S18</span></a>
      <a href="https://archive.org/details/DM_S19_MAK" onclick="ripple(event)"><span class="label">DM_S19</span></a>
      <a href="https://archive.org/details/DM_S20_MAK" onclick="ripple(event)"><span class="label">DM_S20</span></a>
      <div class="movies-row">
        <a href="https://archive.org/details/DM_MOVIES_MAK" onclick="ripple(event)"><span class="label">MOVIES-1</span></a>
        <a href="https://archive.org/details/DM_MOVIES_PT2_MAK" onclick="ripple(event)"><span class="label">MOVIES-2</span></a>
      </div>
    </div>

    <h1 class="heading section-gap">B10 All<br />Seasons</h1>
    <div class="grid">
      <a href="https://archive.org/details/B10_CL_S01_MAK" onclick="ripple(event)"><span class="label">CL_S1</span></a>
      <a href="https://archive.org/details/B10_CL_S02_MAK" onclick="ripple(event)"><span class="label">CL_S2</span></a>
      <a href="https://archive.org/details/B10_CL_S03_MAK" onclick="ripple(event)"><span class="label">CL_S3</span></a>
      <a href="https://archive.org/details/B10_CL_S04_MAK" onclick="ripple(event)"><span class="label">CL_S4</span></a>

      <a href="https://archive.org/details/B10_AF_S01_MAK" onclick="ripple(event)"><span class="label">AF_S1</span></a>
      <a href="https://archive.org/details/B10_AF_S02_MAK" onclick="ripple(event)"><span class="label">AF_S2</span></a>
      <a href="https://archive.org/details/B10_AF_S03_MAK" onclick="ripple(event)"><span class="label">AF_S3</span></a>

      <a href="https://archive.org/details/B10_UA_S01_MAK" onclick="ripple(event)"><span class="label">UA_S1</span></a>
      <a href="https://archive.org/details/B10_UA_S02_MAK" onclick="ripple(event)"><span class="label">UA_S2</span></a>
      <a href="https://archive.org/details/B10_UA_S03_MAK" onclick="ripple(event)"><span class="label">UA_S3</span></a>

      <a href="https://archive.org/details/B10_OV_S01_MAK" onclick="ripple(event)"><span class="label">OV_S1</span></a>
      <a href="https://archive.org/details/B10_OV_S02_MAK" onclick="ripple(event)"><span class="label">OV_S2</span></a>
      <a href="https://archive.org/details/B10_OV_S03_MAK" onclick="ripple(event)"><span class="label">OV_S3</span></a>
      <a href="https://archive.org/details/B10_OV_S04_MAK" onclick="ripple(event)"><span class="label">OV_S4</span></a>
      <a href="https://archive.org/details/B10_OV_S05_MAK" onclick="ripple(event)"><span class="label">OV_S5</span></a>
      <a href="https://archive.org/details/B10_OV_S06_MAK" onclick="ripple(event)"><span class="label">OV_S6</span></a>
      <a href="https://archive.org/details/B10_OV_S07_MAK" onclick="ripple(event)"><span class="label">OV_S7</span></a>
      <a href="https://archive.org/details/B10_OV_S08_MAK" onclick="ripple(event)"><span class="label">OV_S8</span></a>
    </div>

    <h1 class="heading section-gap">Progress Tracker</h1>

    <div style="text-align:center; margin-top:-1rem; opacity:0.8;" id="syncStatus">
      Sync: OFF (local only)
    </div>

    <div class="tools-wrap">
      <div class="tool-card">
        <h2 class="tool-title">Sync</h2>
        <div class="tool-row">
          <div class="tool-field">
           
            <input id="roomInput" class="tool-input" type="text" placeholder="Example: Asim123">
          </div>
          <div class="tool-field">
           
            <button class="save-btn" id="roomSaveBtn" type="button">Save Room Code</button>
          </div>
        </div>
      </div>

      <div class="tool-card">
        <h2 class="tool-title">Profile</h2>
        <div class="seg" id="profileSeg">
          <button type="button" data-profile="Asim">Asim</button>
          <button type="button" data-profile="Marwa">Marwa</button>
        </div>
      </div>

      <div class="tool-card">
        <h2 class="tool-title">Mode</h2>
        <div class="seg" id="modeSeg">
          <button type="button" data-mode="save">Save</button>
          <button type="button" data-mode="recent">Recent Activity</button>
        </div>

        <div id="savePanel">
          <div class="tool-row" style="margin-top:0.9rem;">
            <div class="tool-field">
              <div class="tool-label">Cartoon</div>
              <select id="cartoonSelect" class="tool-select"></select>
            </div>

            <div class="tool-field" id="seriesField">
              <div class="tool-label">Series</div>
              <select id="seriesSelect" class="tool-select"></select>
            </div>
          </div>

          <div class="tool-row" style="margin-top:0.8rem;">
            <div class="tool-field">
              <div class="tool-label">Type</div>
              <select id="typeSelect" class="tool-select">
                <option value="season">Season</option>
                <option value="movie">Movies</option>
              </select>
            </div>

            <div class="tool-field">
              <div class="tool-label" id="seasonLabel">Season</div>
              <select id="seasonOrMovieSelect" class="tool-select"></select>
            </div>
          </div>

          <div class="save-row">
            <div class="tool-field">
              <div class="tool-label">Episode / Movie Number</div>
              <select id="numSelect" class="tool-select"></select>
            </div>

            <div class="tool-field">
              <div class="tool-label">Actions</div>
              <button class="save-btn" id="saveBtn" type="button">Save</button>
            </div>
          </div>

          <div class="tool-mini" id="saveHint"></div>
        </div>

        <div id="recentPanel" class="hidden">
          <div class="tool-row" style="margin-top:0.9rem;">
            <div class="tool-field">
              <div class="tool-label">Cartoon</div>
              <select id="recentCartoonSelect" class="tool-select"></select>
            </div>
            <div class="tool-field">
              <div class="tool-label">Info</div>
              <div class="tool-mini" id="recentInfo">Select a cartoon to view full activity.</div>
            </div>
          </div>

          <div class="activity-list" id="activityList"></div>
        </div>

      </div>
    </div>
  </main>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://tdpyeauwzdktfihqqyxc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WhASrKnpqODlxsod-B1AhQ___lLXnpe";
    const TABLE_NAME = "toonie_progress";

    const ROOM_KEY  = "toonie_room_code_v1";
    const STORE_KEY = "toonie_progress_tracker_v2";

    const SYNC_POLL_MS = 10000;

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MODEL = {
      "Doraemon": {
        label: "DM",
        hasSeries: false,
        seasons: ["S1","S2","S3","S4","S5","S6","S7","S8","S12","S14","S15","S16","S17","S18","S19","S20"],
        hasMovies: true
      },
      "Ben 10": {
        label: "B10",
        hasSeries: true,
        series: ["Classic","Alien Force","Ultimate Alien","Omniverse"],
        seasonsBySeries: {
          "Classic": ["S1","S2","S3","S4"],
          "Alien Force": ["S1","S2","S3"],
          "Ultimate Alien": ["S1","S2","S3"],
          "Omniverse": ["S1","S2","S3","S4","S5","S6","S7","S8"]
        },
        hasMovies: true
      }
    };

    // =========================
    // UI HELPERS
    // =========================
    function setSyncStatus(text) {
      const el = document.getElementById("syncStatus");
      if (el) el.textContent = text;
    }

    function ripple(e) {
      if (navigator.vibrate) navigator.vibrate(30);
      const target = e.currentTarget;
      const rp = document.createElement('span');
      rp.classList.add('ripple');
      rp.style.width = rp.style.height = Math.max(target.offsetWidth, target.offsetHeight) + 'px';
      rp.style.left = e.clientX - target.getBoundingClientRect().left - rp.offsetWidth / 2 + 'px';
      rp.style.top = e.clientY - target.getBoundingClientRect().top - rp.offsetHeight / 2 + 'px';
      target.appendChild(rp);
      setTimeout(() => rp.remove(), 600);
    }

    // Boot overlay fade
    const bootStart = performance.now();
    window.addEventListener('load', () => {
      const MIN_SHOW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--boot-min-show')) || 3500;
      const elapsed = performance.now() - bootStart;
      const wait = Math.max(0, MIN_SHOW - elapsed);

      setTimeout(() => {
        const b = document.getElementById('boot');
        if (b) {
          b.classList.add('hide');
          document.body.classList.add('boot-done');
          const bootFade = (parseFloat(getComputedStyle(b).transitionDuration) || 1.2) * 1000;
          setTimeout(() => b.remove(), bootFade + 50);
        }
      }, wait);
    });

    // =========================
    // STORAGE (ROOM + LOCAL)
    // =========================
    function getRoomCode() {
      return (localStorage.getItem(ROOM_KEY) || "").trim();
    }

    function setRoomCode(code) {
      const clean = String(code || "").trim();
      if (clean) localStorage.setItem(ROOM_KEY, clean);
      else localStorage.removeItem(ROOM_KEY);
      return clean;
    }

    function nowISO(){
      return new Date().toISOString();
    }

    function displayLocal(ts){
      if(!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts).slice(0,16);

      const fmt = new Intl.DateTimeFormat(undefined, {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });

      const parts = fmt.formatToParts(d).reduce((acc, p) => {
        acc[p.type] = p.value;
        return acc;
      }, {});
      return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}`;
    }

    // Normalize seriesLabel: keep local as null (never "-")
    function normalizeSeriesLocal(x){
      const v = (x == null) ? null : String(x).trim();
      if(!v) return null;
      if(v === "-") return null;
      return v;
    }

    function ensurePath(store, profile, cartoonLabel){
      if(!store.data[profile][cartoonLabel]){
        store.data[profile][cartoonLabel] = { last: null, history: [] };
      }
      if(!store.data[profile][cartoonLabel].history){
        store.data[profile][cartoonLabel].history = [];
      }
      return store.data[profile][cartoonLabel];
    }

    // Clean old local data so we don't keep duplicates from the old null vs "-" switch
    function normalizeAndDedupeStore(store){
      const profiles = ["Asim","Marwa"];
      for(const p of profiles){
        if(!store.data[p]) store.data[p] = {};
        for(const cartoonLabel of Object.keys(store.data[p] || {})){
          const node = ensurePath(store, p, cartoonLabel);

          if(node.last){
            node.last.seriesLabel = normalizeSeriesLocal(node.last.seriesLabel);
          }

          // normalize + dedupe by (type, seasonOrMovie, seriesLabel), keep newest ts
          const map = new Map();
          const arr = Array.isArray(node.history) ? node.history : [];
          for(const it of arr){
            if(!it) continue;
            it.seriesLabel = normalizeSeriesLocal(it.seriesLabel);
            const key = `${it.type}|${it.seasonOrMovie}|${it.seriesLabel || ""}`;
            const prev = map.get(key);
            if(!prev || (String(it.ts) > String(prev.ts))){
              map.set(key, it);
            }
          }

          const merged = Array.from(map.values())
            .sort((a,b) => String(b.ts).localeCompare(String(a.ts)));

          node.history = merged;

          // make sure node.last is the real latest event for that cartoon
          if(merged.length){
            const latest = merged[0];
            if(!node.last || String(latest.ts) > String(node.last.ts)){
              node.last = latest;
            }
          }
        }
      }
      return store;
    }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw){
          return normalizeAndDedupeStore({ activeProfile: "Asim", data: { Asim: {}, Marwa: {} } });
        }
        const obj = JSON.parse(raw);
        if(!obj.data) obj.data = { Asim: {}, Marwa: {} };
        if(!obj.data.Asim) obj.data.Asim = {};
        if(!obj.data.Marwa) obj.data.Marwa = {};
        if(!obj.activeProfile) obj.activeProfile = "Asim";
        return normalizeAndDedupeStore(obj);
      } catch {
        return normalizeAndDedupeStore({ activeProfile: "Asim", data: { Asim: {}, Marwa: {} } });
      }
    }

    function saveStore(store){
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
    }

    function formatLine(entry){
      const parts = [];
      parts.push(entry.cartoonLabel);

      // Only show series if it's a real series (Ben 10). Doraemon stays clean.
      if(entry.seriesLabel) parts.push(entry.seriesLabel);

      if(entry.type === "season"){
        parts.push(entry.seasonOrMovie);
        parts.push(`EP ${entry.num}`);
      } else {
        parts.push("MOVIES");
        parts.push(`M${entry.num}`);
      }
      return parts.join(" ");
    }

    function upsertEntry(store, profile, entry){
      const node = ensurePath(store, profile, entry.cartoonLabel);

      // local seriesLabel should always be normalized
      entry.seriesLabel = normalizeSeriesLocal(entry.seriesLabel);

      // Keep "global last" for the cartoon = newest ts
      if(!node.last || String(entry.ts) >= String(node.last.ts)){
        node.last = entry;
      }

      const keySeries = entry.seriesLabel || null;

      const idx = node.history.findIndex(h =>
        (h.type === entry.type) &&
        (h.seasonOrMovie === entry.seasonOrMovie) &&
        (normalizeSeriesLocal(h.seriesLabel) === keySeries)
      );

      if(idx >= 0){
        // replace if newer
        const old = node.history[idx];
        if(!old || String(entry.ts) >= String(old.ts)){
          node.history[idx] = entry;
        }
      } else {
        node.history.unshift(entry);
      }

      // keep history ordered
      node.history.sort((a,b) => String(b.ts).localeCompare(String(a.ts)));
    }

    // =========================
    // SUPABASE HELPERS (CLOUD)
    // =========================
    function supabaseEnabled(){
      return !!(SUPABASE_URL && SUPABASE_ANON_KEY && supabaseClient);
    }

    async function sbUpsertProgress(row){
      const room = getRoomCode();
      if(!room) return { ok: false, skipped: true };

      // IMPORTANT: cloud series_label must be NOT NULL => send "-" if no series
      const cloudSeries = (row.series_label == null || String(row.series_label).trim() === "")
        ? "-"
        : String(row.series_label);

      const payload = {
        room_code: room,
        profile: row.profile,
        cartoon_label: row.cartoon_label,
        series_label: cloudSeries,
        type: row.type,
        season_or_movie: row.season_or_movie,
        num: Number(row.num) || 0,
        ts: row.ts
      };

      const { error } = await supabaseClient
        .from(TABLE_NAME)
        .upsert(payload, {
          onConflict: "room_code,profile,cartoon_label,series_label,type,season_or_movie"
        });

      if(error){
        console.error("Cloud upsert error:", error);
        return { ok: false, error: error.message || "Cloud upsert failed" };
      }
      return { ok: true };
    }

    async function sbFetchProgress(room, profile, limit = 250){
      if(!room) return { ok: false, skipped: true, rows: [] };

      const { data, error } = await supabaseClient
        .from(TABLE_NAME)
        .select("room_code,profile,cartoon_label,series_label,type,season_or_movie,num,ts")
        .eq("room_code", room)
        .eq("profile", profile)
        .order("ts", { ascending: false })
        .limit(limit);

      if(error){
        console.error("Cloud fetch error:", error);
        return { ok: false, error: error.message || "Cloud fetch failed", rows: [] };
      }
      return { ok: true, rows: data || [] };
    }

    // =========================
    // APP
    // =========================

// =========================
// ALL-IN BACKGROUND FX
// =========================
(function initAllInFX(){
  const canvas = document.getElementById("fxCanvas");
  const glow = document.getElementById("cursorGlow");
  if(!canvas || !glow) return;

  const ctx = canvas.getContext("2d", { alpha: true });
  let w = 0, h = 0, dpr = Math.min(2, window.devicePixelRatio || 1);

  const particles = [];
  const PCOUNT = 95; // increase to 140 if you want even crazier

  // mouse/touch target
  let tx = window.innerWidth * 0.5;
  let ty = window.innerHeight * 0.35;
  let gx = tx, gy = ty;

  // idle detection for glow intensity
  let idleTimer = null;
  function markActive(){
    document.body.classList.remove("fx-idle");
    clearTimeout(idleTimer);
    idleTimer = setTimeout(() => document.body.classList.add("fx-idle"), 1500);
  }

  function resize(){
    w = Math.floor(window.innerWidth);
    h = Math.floor(window.innerHeight);
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function rand(min,max){ return Math.random()*(max-min)+min; }

  function spawn(){
    particles.length = 0;
    for(let i=0;i<PCOUNT;i++){
      particles.push({
        x: rand(0,w),
        y: rand(0,h),
        r: rand(0.9, 2.6),
        vx: rand(-0.25, 0.25),
        vy: rand(-0.18, 0.18),
        a: rand(0.25, 0.85),
        tw: rand(0.008, 0.02) // twinkle
      });
    }
  }

  function draw(){
    ctx.clearRect(0,0,w,h);

    // soft gradient wash (aurora)
    const g = ctx.createRadialGradient(w*0.25,h*0.2, 80, w*0.25,h*0.2, Math.max(w,h)*0.9);
    g.addColorStop(0, "rgba(0,240,255,0.10)");
    g.addColorStop(0.45, "rgba(250,204,21,0.07)");
    g.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // sparkles
    for(const p of particles){
      p.x += p.vx;
      p.y += p.vy;

      // wrap around edges
      if(p.x < -10) p.x = w+10;
      if(p.x > w+10) p.x = -10;
      if(p.y < -10) p.y = h+10;
      if(p.y > h+10) p.y = -10;

      // subtle pull toward cursor/touch
      const dx = gx - p.x;
      const dy = gy - p.y;
      const dist = Math.sqrt(dx*dx + dy*dy) || 1;
      const pull = Math.min(0.04, 18/dist) * 0.0016;
      p.vx += dx * pull;
      p.vy += dy * pull;

      // dampen speed
      p.vx *= 0.995;
      p.vy *= 0.995;

      // twinkle
      p.a += (Math.random()-0.5) * p.tw;
      p.a = Math.max(0.15, Math.min(0.95, p.a));

      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fillStyle = `rgba(255,255,255,${p.a})`;
      ctx.fill();
    }

    requestAnimationFrame(draw);
  }

  function setTarget(x,y){
    tx = x; ty = y;
    markActive();
  }

  // smooth follow
  function follow(){
    gx += (tx - gx) * 0.08;
    gy += (ty - gy) * 0.08;

    // move glow
    glow.style.left = gx + "px";
    glow.style.top = gy + "px";

    requestAnimationFrame(follow);
  }

  window.addEventListener("resize", () => { resize(); spawn(); });

  window.addEventListener("mousemove", (e) => setTarget(e.clientX, e.clientY), { passive: true });

  window.addEventListener("touchstart", (e) => {
    const t = e.touches && e.touches[0];
    if(t) setTarget(t.clientX, t.clientY);
  }, { passive: true });

  window.addEventListener("touchmove", (e) => {
    const t = e.touches && e.touches[0];
    if(t) setTarget(t.clientX, t.clientY);
  }, { passive: true });

  // init
  resize();
  spawn();
  markActive();
  follow();
  draw();
})();

    
    function initTracker(){
      const profileSeg = document.getElementById("profileSeg");
      const modeSeg = document.getElementById("modeSeg");

      const savePanel = document.getElementById("savePanel");
      const recentPanel = document.getElementById("recentPanel");

      const cartoonSelect = document.getElementById("cartoonSelect");
      const seriesField = document.getElementById("seriesField");
      const seriesSelect = document.getElementById("seriesSelect");
      const typeSelect = document.getElementById("typeSelect");
      const seasonLabel = document.getElementById("seasonLabel");
      const seasonOrMovieSelect = document.getElementById("seasonOrMovieSelect");
      const numSelect = document.getElementById("numSelect");

      const saveBtn = document.getElementById("saveBtn");
      const saveHint = document.getElementById("saveHint");

      const recentCartoonSelect = document.getElementById("recentCartoonSelect");
      const recentInfo = document.getElementById("recentInfo");
      const activityList = document.getElementById("activityList");

      const roomInput = document.getElementById("roomInput");
      const roomSaveBtn = document.getElementById("roomSaveBtn");
      const roomStatus = document.getElementById("roomStatus");

      if(!profileSeg || !modeSeg) return;

      let store = loadStore();
      // write back cleaned store so duplicates are gone immediately
      saveStore(store);

      let activeProfile = store.activeProfile || "Asim";
      let activeMode = "save";
      let pollTimer = null;
      let lastCloudOk = true;

      function vib(){ if(navigator.vibrate) navigator.vibrate(20); }

      function updateRoomStatus(msg){
        if(roomStatus) roomStatus.textContent = msg;
      }

      function refreshRoomUI(){
        const room = getRoomCode();
        if(roomInput) roomInput.value = room;

        if(!room){
          setSyncStatus("Sync: OFF (local only)");
          updateRoomStatus("Sync: OFF (no room code). Local save only.");
          return;
        }

        if(!supabaseEnabled()){
          setSyncStatus(`Sync: OFF (Room: ${room})`);
          updateRoomStatus(`Room: ${room} → Sync OFF (Supabase not available).`);
          return;
        }

        setSyncStatus(`Sync: ON (Room: ${room})`);
        //updateRoomStatus(`Room: ${room} → Sync ON (auto refresh every ${Math.round(SYNC_POLL_MS/1000)}s).`);
      }

      function setProfileUI(){
        [...profileSeg.querySelectorAll("button")].forEach(b => {
          b.classList.toggle("active", b.dataset.profile === activeProfile);
        });
      }

      function setModeUI(){
        [...modeSeg.querySelectorAll("button")].forEach(b => {
          b.classList.toggle("active", b.dataset.mode === activeMode);
        });

        if(activeMode === "save"){
          savePanel.classList.remove("hidden");
          recentPanel.classList.add("hidden");
        } else {
          savePanel.classList.add("hidden");
          recentPanel.classList.remove("hidden");
          renderRecent();
        }
      }

      function cartoonsList(){ return Object.keys(MODEL); }
      function getCartoonCfg(name){ return MODEL[name]; }

      function fillCartoonSelects(){
        const opts = cartoonsList().map(c => `<option value="${c}">${c}</option>`).join("");
        cartoonSelect.innerHTML = opts;
        recentCartoonSelect.innerHTML = opts;
      }

      function fillSeries(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(!cfg || !cfg.hasSeries){
          seriesField.classList.add("hidden");
          seriesSelect.innerHTML = "";
          return;
        }
        seriesField.classList.remove("hidden");
        seriesSelect.innerHTML = cfg.series.map(s => `<option value="${s}">${s}</option>`).join("");
      }

      function fillSeasonOrMovie(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        const type = typeSelect.value;

        if(type === "movie"){
          seasonLabel.textContent = "Movies";
          seasonOrMovieSelect.innerHTML = `<option value="Movies">Movies</option>`;
          return;
        }

        seasonLabel.textContent = "Season";

        let seasons = [];
        if(cfg.hasSeries){
          const s = seriesSelect.value;
          seasons = (cfg.seasonsBySeries && cfg.seasonsBySeries[s]) ? cfg.seasonsBySeries[s] : [];
        } else {
          seasons = cfg.seasons || [];
        }

        seasonOrMovieSelect.innerHTML = seasons.map(x => `<option value="${x}">${x}</option>`).join("");
      }

      function fillEpisodeDropdown(max = 100){
        let html = "";
        for(let i=1; i<=max; i++){
          html += `<option value="${i}">${i}</option>`;
        }
        numSelect.innerHTML = html;
        numSelect.value = "1";
      }

      function currentKeyLabels(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        const cartoonLabel = cfg.label;

        const type = typeSelect.value;

        // LOCAL: Doraemon has no series => keep null locally
        let seriesLabel = null;

        if(cfg.hasSeries){
          const s = seriesSelect.value;
          seriesLabel = (s === "Classic") ? "CL" :
                        (s === "Alien Force") ? "AF" :
                        (s === "Ultimate Alien") ? "UA" :
                        (s === "Omniverse") ? "OV" : s;
        }

        const seasonOrMovie = seasonOrMovieSelect.value;

        return { cartoonLabel, seriesLabel, type, seasonOrMovie };
      }

      function updateSaveHintForCartoon(){
        store = loadStore();
        const cfg = getCartoonCfg(cartoonSelect.value);
        const cartoonLabel = cfg.label;
        const node = ensurePath(store, activeProfile, cartoonLabel);

        if(node.last){
          saveHint.textContent = `Last Watched: ${formatLine(node.last)} (${displayLocal(node.last.ts)})`;
        } else {
          saveHint.textContent = "No activity yet for this cartoon.";
        }
      }

      function renderRecent(){
        store = loadStore();
        const cartoonName = recentCartoonSelect.value;
        const cfg = getCartoonCfg(cartoonName);
        const cartoonLabel = cfg.label;

        const node = ensurePath(store, activeProfile, cartoonLabel);
        const list = node.history || [];

        if(list.length === 0){
          recentInfo.textContent = "No activity yet.";
          activityList.innerHTML = "";
          return;
        }

        recentInfo.textContent = `Showing all activity for ${cartoonLabel} (${activeProfile})`;
        activityList.innerHTML = list
          .map(item => `
            <div class="activity-item">
              <div>${formatLine(item)}</div>
              <div class="right">${displayLocal(item.ts)}</div>
            </div>
          `)
          .join("");
      }

      async function pollFromCloud(){
        const room = getRoomCode();
        if(!room || !supabaseEnabled()) return;

        const res = await sbFetchProgress(room, activeProfile, 250);
        if(!res.ok){
          if(lastCloudOk){
            updateRoomStatus(`Room: ${room} → Sync ON, but fetch failed. (Will keep trying)`);
          }
          lastCloudOk = false;
          return;
        }

        lastCloudOk = true;

        store = loadStore();

        for(const r of res.rows){
          const entry = {
            cartoonLabel: r.cartoon_label,
            // CLOUD "-" => LOCAL null
            seriesLabel: normalizeSeriesLocal(r.series_label),
            type: r.type,
            seasonOrMovie: r.season_or_movie,
            num: Number(r.num) || 1,
            ts: r.ts
          };
          upsertEntry(store, activeProfile, entry);
        }

        store = normalizeAndDedupeStore(store);
        saveStore(store);

        updateSaveHintForCartoon();
        if(activeMode === "recent") renderRecent();
        refreshRoomUI();
      }

      function startPolling(){
        stopPolling();
        const room = getRoomCode();
        if(!room || !supabaseEnabled()) return;

        pollTimer = setInterval(() => {
          pollFromCloud().catch(() => {});
        }, SYNC_POLL_MS);

        pollFromCloud().catch(() => {});
      }

      function stopPolling(){
        if(pollTimer){
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }

      async function doSave(){
        vib();
        store = loadStore();

        const cur = currentKeyLabels();
        const num = Math.max(1, Math.min(100, Number(numSelect.value) || 1));

        const entry = {
          cartoonLabel: cur.cartoonLabel,
          seriesLabel: normalizeSeriesLocal(cur.seriesLabel), // local normalized
          type: cur.type,
          seasonOrMovie: cur.seasonOrMovie,
          num,
          ts: nowISO()
        };

        // LOCAL SAVE ALWAYS
        upsertEntry(store, activeProfile, entry);
        store = normalizeAndDedupeStore(store);
        saveStore(store);

        saveHint.textContent = `Saved: ${formatLine(entry)} (${displayLocal(entry.ts)})`;

        // CLOUD SAVE IF POSSIBLE
        const room = getRoomCode();
        if(!room || !supabaseEnabled()){
          return;
        }

        const push = await sbUpsertProgress({
          profile: activeProfile,
          cartoon_label: entry.cartoonLabel,
          // only cloud gets "-"
          series_label: entry.seriesLabel || "-",
          type: entry.type,
          season_or_movie: entry.seasonOrMovie,
          num: entry.num,
          ts: entry.ts
        });

        if(push.ok){
          pollFromCloud().catch(() => {});
        } else {
          saveHint.textContent = `Saved locally. (Cloud failed: ${push.error || "blocked"})`;
        }
      }

      // ===== INIT =====
      fillCartoonSelects();
      fillSeries();
      fillSeasonOrMovie();
      fillEpisodeDropdown(100);

      setProfileUI();
      setModeUI();

      recentCartoonSelect.value = cartoonSelect.value;

      refreshRoomUI();
      updateSaveHintForCartoon();
      startPolling();

      // ===== EVENTS =====
      profileSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        vib();

        activeProfile = btn.dataset.profile;

        store = loadStore();
        store.activeProfile = activeProfile;
        saveStore(store);

        setProfileUI();
        updateSaveHintForCartoon();
        if(activeMode === "recent") renderRecent();
        startPolling();
      });

      modeSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        vib();
        activeMode = btn.dataset.mode;
        setModeUI();
      });

      cartoonSelect.addEventListener("change", () => {
        fillSeries();
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(!cfg.hasMovies) typeSelect.value = "season";

        fillSeasonOrMovie();
        updateSaveHintForCartoon();

        recentCartoonSelect.value = cartoonSelect.value;
        if(activeMode === "recent") renderRecent();
      });

      seriesSelect.addEventListener("change", () => {
        fillSeasonOrMovie();
        updateSaveHintForCartoon();
      });

      typeSelect.addEventListener("change", () => {
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(typeSelect.value === "movie" && !cfg.hasMovies) typeSelect.value = "season";
        fillSeasonOrMovie();
        updateSaveHintForCartoon();
      });

      seasonOrMovieSelect.addEventListener("change", () => {
        updateSaveHintForCartoon();
      });

      saveBtn.addEventListener("click", () => { doSave().catch(() => {}); });

      recentCartoonSelect.addEventListener("change", renderRecent);

      if(roomSaveBtn && roomInput){
        roomSaveBtn.addEventListener("click", () => {
          vib();
          const code = (roomInput.value || "").trim();
          setRoomCode(code);
          refreshRoomUI();
          startPolling();
        });
      }

      if(roomInput){
        roomInput.addEventListener("keydown", (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
            if(roomSaveBtn) roomSaveBtn.click();
          }
        });
      }
    }

    window.addEventListener("load", initTracker);
  </script>
</body>
</html>
