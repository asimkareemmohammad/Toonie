<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toonie</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/192.png" type="image/png" sizes="192x192">
  <link rel="icon" href="icons/512.png" type="image/png" sizes="512x512">

  <meta name="theme-color" content="#0f0f0f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Toonie">
  <meta name="mobile-web-app-capable" content="yes">

  <style>
    /* PERFORMANCE OPTIMIZATIONS APPLIED:
    1. Reduced compositor layers
    2. Optimized CSS animations
    3. Removed expensive filters on low-end devices
    4. Added will-change only where needed
    5. Reduced paint complexity
    */

    :root{
      --boot-min-show: 1500ms; /* Reduced from 3500ms */
      --boot-fade: 800ms;      /* Reduced from 1200ms */
      --app-fade: 500ms;       /* Reduced from 700ms */
      --app-fade-delay: 50ms;  /* Reduced from 150ms */

      /* ===== Unified Glass Theme ===== */
      --bg: #0f0f0f;
      --glass: rgba(30,30,30,0.64);
      --glass-strong: rgba(30,30,30,0.78);
      --border: rgba(255,255,255,0.08);
      --border-soft: rgba(255,255,255,0.06);
      --shadow: 0 8px 20px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.03) inset;
      --shadow-soft: 0 6px 15px rgba(0,0,0,0.25);
      --radius-pill: 999px;
      --radius-card: 18px;     /* Reduced from 22px */
      --blur: blur(8px);       /* Reduced from 12px */

      --accentA: #facc15;
      --accentB: #00f0ff;
      --shineSpeed: 4s;        /* Slowed down for performance */
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
      /* Prevent expensive overscroll behavior */
      overscroll-behavior-y: none;
      /* Hardware acceleration */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #app {
      opacity: 0;
      transform: scale(0.99);
      transition:
        opacity var(--app-fade) ease var(--app-fade-delay),
        transform var(--app-fade) ease var(--app-fade-delay);
      padding-bottom: 2rem; /* Reduced from 3rem */
    }
    .boot-done #app { opacity: 1; transform: scale(1); }

    .heading {
      font-size: 1.8rem;      /* Reduced from 2rem */
      margin: 1.5rem auto;    /* Reduced from 2rem */
      text-align: center;
      line-height: 1.3;
      width: 100%;
      background: linear-gradient(90deg, var(--accentA), var(--accentB), var(--accentA));
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      /* Only animate if user prefers motion */
      animation: shine var(--shineSpeed) linear infinite paused;
    }
    
    /* Start animation only after page is ready */
    .boot-done .heading {
      animation-play-state: running;
    }
    
    @keyframes shine { 
      0% { background-position: 200% center; }
      100% { background-position: -200% center; }
    }

    .section-gap { margin-top: 1.2rem; } /* Reduced from 1.5rem */

    /* Layout wrappers */
    .panel-wrap{
      max-width: 780px;       /* Reduced from 820px */
      margin: 0 auto;
      padding: 0 1.5rem;      /* Reduced from 2rem */
      box-sizing: border-box;
    }

    /* OPTIMIZED GRID - Fixed columns for better performance */
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.8rem;            /* Reduced from 1rem */
      width: 100%;
      box-sizing: border-box;
      margin: 0 auto;
      /* Prevent expensive layout calculations */
      contain: layout style;
    }

    /* Center 3-item grids */
    .grid-three-items {
      grid-template-columns: repeat(3, 1fr);
      max-width: 420px;       /* Reduced from 480px */
      margin: 0 auto;
    }

    /* For movie grid (2 items) */
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.8rem;
      width: 100%;
      max-width: 320px;       /* Reduced from 400px */
      margin: 0 auto;
      contain: layout style;
    }

    /* Menu buttons grid */
    .menu-grid{
      grid-template-columns: repeat(2, 1fr);
      max-width: 520px;       /* Reduced from 640px */
      padding-bottom: 1rem;   /* Reduced from 1.2rem */
      margin: 0 auto;
      contain: layout style;
    }

    .menu-btn{
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 48px;       /* Reduced from 56px */
    }

    /* OPTIMIZED BUTTONS - Reduced paint complexity */
    a {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--glass-strong);
      border: 1px solid var(--border);
      padding: 0.65rem 0.4rem; /* Reduced padding */
      text-align: center;
      border-radius: var(--radius-pill);
      text-decoration: none;
      position: relative;
      overflow: hidden;
      transition:
        transform 120ms cubic-bezier(.2,.8,.2,1), /* Faster transition */
        box-shadow 120ms cubic-bezier(.2,.8,.2,1),
        filter 120ms ease;
      -webkit-tap-highlight-color: transparent;
      color: inherit;
      transform: translateZ(0); /* Hardware acceleration */
      box-shadow: var(--shadow);
      /* Conditional backdrop-filter for performance */
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      min-height: 42px;       /* Reduced from 48px */
      word-break: break-word;
      /* Reduce paint area */
      contain: layout style paint;
    }

    /* Disable expensive effects on low-end devices */
    @media (prefers-reduced-motion: reduce), (max-width: 768px) {
      a {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
    }

    a span.label {
      display: inline-block;
      background: linear-gradient(90deg, var(--accentA), var(--accentB), var(--accentA));
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine var(--shineSpeed) linear infinite paused;
      letter-spacing: 0.1px;
      font-size: 0.9rem;      /* Slightly smaller */
      text-align: center;
      width: 100%;
    }
    
    .boot-done a span.label {
      animation-play-state: running;
    }

    /* OPTIMIZED RIPPLE - Reduced animation complexity */
    a span.ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 1s ease-out; /* Faster and simpler */
      background-color: rgba(0, 240, 255, 0.2); /* More transparent */
      pointer-events: none;
      /* Isolate ripple to prevent repaints */
      isolation: isolate;
    }
    @keyframes ripple { 
      to { 
        transform: scale(3); /* Reduced from scale(4) */
        opacity: 0; 
      } 
    }

    a:active{
      transform: translateY(1px) scale(0.99);
      box-shadow:
        0 4px 12px rgba(0,0,0,0.35),
        0 1px 0 rgba(255,255,255,0.03) inset;
      filter: brightness(1.04); /* Reduced from 1.06 */
    }
    a:hover{
      transform: translateY(-1px) scale(1.005); /* Reduced movement */
      box-shadow:
        0 10px 22px rgba(0,0,0,0.45),
        0 1px 0 rgba(255,255,255,0.04) inset;
    }

    /* Optimized pseudo-elements */
    a::before{
      content:"";
      position:absolute;
      inset: 0;
      pointer-events:none;
      /* Simplified gradient for performance */
      background: radial-gradient(80px 60px at 25% 15%, rgba(255,255,255,0.07), transparent 50%);
      opacity: 0.8;
      /* Don't trigger repaints */
      will-change: opacity;
    }

    a::after{
      content:"";
      position:absolute;
      inset:-1px;            /* Reduced from -2px */
      border-radius: var(--radius-pill);
      pointer-events:none;
      border: 1px solid rgba(0,240,255,0.08); /* Thinner border */
      opacity: 0;
      transform: scale(0.99);
      transition: opacity 150ms ease, transform 150ms ease;
      will-change: opacity, transform;
    }
    a:hover::after{
      opacity: 1;
      transform: scale(1);
    }

    /* Motion preferences */
    @media (prefers-reduced-motion: reduce){
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      a:hover, a:active {
        transform: none !important;
      }
    }

    /* Responsive adjustments - Optimized breakpoints */
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .menu-grid {
        max-width: 400px;
      }
      
      .grid-three-items {
        grid-template-columns: repeat(2, 1fr);
        max-width: 280px;
      }
      
      .heading {
        font-size: 1.5rem;
        margin: 1.2rem auto;
      }
    }

    @media (max-width: 480px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.6rem;
      }
      
      .grid-three-items {
        grid-template-columns: repeat(2, 1fr);
        max-width: 240px;
      }
      
      .menu-grid {
        max-width: 100%;
        padding: 0 0.8rem 0.8rem; /* Reduced padding */
      }
      
      .panel-wrap {
        padding: 0 0.8rem; /* Reduced padding */
      }
      
      a {
        padding: 0.6rem 0.3rem;
        font-size: 0.85rem;
        min-height: 38px;
      }
      
      .heading {
        font-size: 1.3rem;
        margin: 1rem auto;
      }
    }

    /* ===== OPTIMIZED PANEL ANIMATIONS ===== */
    .panel{
      overflow: hidden;
      margin: 0;
      padding: 0;
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px); /* Reduced from -6px */
      pointer-events: none;
      /* Faster transitions with simpler timing */
      transition: max-height 320ms cubic-bezier(.1,.8,.1,1), 
                  opacity 180ms ease, 
                  transform 180ms ease;
      /* Only will-change when animating */
      will-change: max-height;
      /* Contain for performance */
      contain: layout style;
    }
    .panel.open{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
      margin-top: 10px; /* Reduced from 14px */
      /* Remove will-change after animation */
      will-change: auto;
    }

    /* ===== Boot Overlay ===== */
    #boot {
      position: fixed;
      inset: 0;
      background: #0f0f0f;
      z-index: 9999;
      opacity: 1;
      transition: opacity var(--boot-fade) ease;
      /* Prevent interaction during boot */
      pointer-events: all;
    }
    #boot.hide { 
      opacity: 0; 
      pointer-events: none; 
      /* Don't keep in DOM after hiding */
      display: none;
    }

    /* ===== OPTIMIZED PROGRESS TRACKER ===== */
    .tools-wrap{
      width: 100%;
      max-width: 780px;      /* Reduced from 820px */
      margin: 0 auto 2rem;   /* Reduced from 3rem */
      padding: 0 1.5rem;     /* Reduced from 2rem */
      box-sizing: border-box;
    }

    .tool-card{
      background: var(--glass);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      padding: 1rem;         /* Reduced from 1.25rem */
      box-shadow: var(--shadow-soft);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      margin-top: 0.8rem;    /* Reduced from 1rem */
      position: relative;
      overflow: hidden;
      contain: layout style;
    }
    
    @media (prefers-reduced-motion: reduce), (max-width: 768px) {
      .tool-card {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
    }

    .tool-card::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: radial-gradient(120px 70px at 20% 10%, rgba(255,255,255,0.08), transparent 55%);
      opacity: 0.8;
    }

    .tool-title{
      font-size: 1.1rem;     /* Reduced from 1.15rem */
      margin: 0 0 0.7rem 0;  /* Reduced from 0.85rem */
      background: linear-gradient(90deg, var(--accentA), var(--accentB), var(--accentA));
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shine var(--shineSpeed) linear infinite paused;
      position: relative;
      z-index: 1;
    }
    
    .boot-done .tool-title {
      animation-play-state: running;
    }

    .tool-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.7rem;           /* Reduced from 0.85rem */
      align-items: end;
      position: relative;
      z-index: 1;
    }
    @media (max-width: 640px){
      .tool-row{ 
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }
    }

    .tool-field{
      display: flex;
      flex-direction: column;
      gap: 0.3rem;           /* Reduced from 0.35rem */
      position: relative;
      z-index: 1;
    }

    .tool-label{
      font-size: 0.85rem;    /* Reduced from 0.9rem */
      opacity: 0.85;
    }

    .tool-input, .tool-select{
      width: 100%;
      background: rgba(21,21,21,0.7);
      border: 1px solid rgba(255,255,255,0.08);
      color: #fff;
      border-radius: 12px;   /* Reduced from 14px */
      padding: 0.65rem 0.8rem; /* Reduced padding */
      outline: none;
      font-size: 0.9rem;     /* Reduced from 0.95rem */
      box-sizing: border-box;
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      transition: border-color 150ms ease, 
                  box-shadow 150ms ease, 
                  transform 120ms ease;
      /* Prevent layout shifts */
      min-height: 42px;
    }
    
    @media (prefers-reduced-motion: reduce), (max-width: 768px) {
      .tool-input, .tool-select {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
    }

    .tool-input:focus, .tool-select:focus{
      border-color: rgba(0,240,255,0.55);
      box-shadow: 0 0 0 2px rgba(0,240,255,0.1); /* Reduced from 3px */
      transform: translateY(-1px);
    }

    .seg{
      display: flex;
      gap: 0.45rem;          /* Reduced from 0.55rem */
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }

    .seg button{
      background: rgba(21,21,21,0.65);
      border: 1px solid rgba(255,255,255,0.08);
      color: #fff;
      border-radius: var(--radius-pill);
      padding: 0.5rem 0.8rem; /* Reduced padding */
      cursor: pointer;
      transition:
        transform 120ms cubic-bezier(.2,.8,.2,1),
        box-shadow 120ms cubic-bezier(.2,.8,.2,1),
        border-color 150ms ease,
        background-color 150ms ease;
      box-shadow: 0 6px 14px rgba(0,0,0,0.3); /* Reduced shadow */
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      min-height: 36px;
    }
    
    @media (prefers-reduced-motion: reduce), (max-width: 768px) {
      .seg button {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
    }
    
    .seg button:hover{ transform: translateY(-1px); }
    .seg button:active{ transform: translateY(1px) scale(0.99); }
    .seg button.active{
      border-color: rgba(0,240,255,0.55);
      background: rgba(0,240,255,0.08);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35); /* Reduced shadow */
    }

    .tool-mini{
      font-size: 0.85rem;    /* Reduced from 0.92rem */
      opacity: 0.9;
      margin-top: 0.7rem;    /* Reduced from 0.85rem */
      line-height: 1.4;
      position: relative;
      z-index: 1;
    }

    .save-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.7rem;           /* Reduced from 0.85rem */
      margin-top: 0.7rem;    /* Reduced from 0.85rem */
      position: relative;
      z-index: 1;
    }
    @media (max-width: 640px){
      .save-row{ 
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }
    }

    .save-btn{
      width: 100%;
      background: rgba(30,30,30,0.62);
      border: 1px solid rgba(255,255,255,0.08);
      color: #fff;
      border-radius: 14px;   /* Reduced from 16px */
      padding: 0.65rem 0.8rem; /* Reduced padding */
      cursor: pointer;
      transition:
        transform 120ms cubic-bezier(.2,.8,.2,1),
        box-shadow 120ms cubic-bezier(.2,.8,.2,1),
        border-color 150ms ease,
        background-color 150ms ease;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35); /* Reduced shadow */
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      min-height: 42px;
    }
    
    @media (prefers-reduced-motion: reduce), (max-width: 768px) {
      .save-btn {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
    }
    
    .save-btn:hover{ transform: translateY(-1px); }
    .save-btn:active{ transform: translateY(1px) scale(0.99); }

    .activity-list{
      margin-top: 0.7rem;    /* Reduced from 0.85rem */
      display: flex;
      flex-direction: column;
      gap: 0.5rem;           /* Reduced from 0.6rem */
      max-height: 280px;     /* Reduced from 320px */
      overflow: auto;
      padding-right: 0.2rem; /* Reduced from 0.25rem */
      position: relative;
      z-index: 1;
      /* Smooth scrolling */
      scroll-behavior: smooth;
      /* Better scroll performance */
      -webkit-overflow-scrolling: touch;
    }

    .activity-item{
      background: rgba(21,21,21,0.68);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;   /* Reduced from 16px */
      padding: 0.7rem 0.8rem; /* Reduced padding */
      font-size: 0.9rem;     /* Reduced from 0.95rem */
      line-height: 1.3;
      display: flex;
      justify-content: space-between;
      gap: 0.6rem;           /* Reduced from 0.8rem */
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      /* Prevent expensive repaints */
      contain: layout style;
    }
    
    @media (prefers-reduced-motion: reduce), (max-width: 768px) {
      .activity-item {
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
      }
    }
    
    .activity-item .right{
      opacity: 0.75;
      font-size: 0.8rem;     /* Reduced from 0.85rem */
      white-space: nowrap;
      flex-shrink: 0;
    }

    .hidden{ display: none !important; }
    
    /* Performance helper class */
    .perf-optimize {
      /* Prevent expensive background painting */
      background-attachment: fixed;
    }
  </style>
</head>

<body>
  <div id="boot"></div>

  <main id="app">

   <h1 class="heading">Doraemon</h1>

    <!-- DM: Top buttons -->
    <div class="grid menu-grid">
      <a class="menu-btn" href="#" onclick="toggleDM(event, 'dm-seasons')"><span class="label">Seasons</span></a>
      <a class="menu-btn" href="#" onclick="toggleDM(event, 'dm-movies')"><span class="label">Movies</span></a>
    </div>

    <!-- DM: Seasons panel -->
    <div class="panel-wrap">
      <div id="dm-seasons" class="grid panel dm-panel">
        <a href="https://archive.org/details/dm-s1-mak" onclick="ripple(event)"><span class="label">DM_S1</span></a>
        <a href="https://archive.org/details/doraemon-s2-mak" onclick="ripple(event)"><span class="label">DM_S2</span></a>
        <a href="https://archive.org/details/DM-S3-MAK" onclick="ripple(event)"><span class="label">DM_S3</span></a>
        <a href="https://archive.org/details/DM-S4-MAK" onclick="ripple(event)"><span class="label">DM_S4</span></a>
        <a href="https://archive.org/details/DM-S5-MAK" onclick="ripple(event)"><span class="label">DM_S5</span></a>
        <a href="https://archive.org/details/DM-S6-MAK2" onclick="ripple(event)"><span class="label">DM_S6</span></a>
        <a href="https://archive.org/details/DM-S7-MAK" onclick="ripple(event)"><span class="label">DM_S7</span></a>
        <a href="https://archive.org/details/DM-S8-MAK" onclick="ripple(event)"><span class="label">DM_S8</span></a>
        <a href="https://archive.org/details/DM-S12-MAK" onclick="ripple(event)"><span class="label">DM_S12</span></a>
        <a href="https://archive.org/details/DM_S14_MAK" onclick="ripple(event)"><span class="label">DM_S14</span></a>
        <a href="https://archive.org/details/DM_S15_MAK" onclick="ripple(event)"><span class="label">DM_S15</span></a>
        <a href="https://archive.org/details/DM_S16_MAK" onclick="ripple(event)"><span class="label">DM_S16</span></a>
        <a href="https://archive.org/details/DM_S17_MAK" onclick="ripple(event)"><span class="label">DM_S17</span></a>
        <a href="https://archive.org/details/DM_S18_MAK" onclick="ripple(event)"><span class="label">DM_S18</span></a>
        <a href="https://archive.org/details/DM_S19_MAK" onclick="ripple(event)"><span class="label">DM_S19</span></a>
        <a href="https://archive.org/details/DM_S20_MAK" onclick="ripple(event)"><span class="label">DM_S20</span></a>
      </div>

      <!-- DM: Movies panel -->
      <div id="dm-movies" class="panel dm-panel">
        <div class="grid-2">
          <a href="https://archive.org/details/DM_MOVIES_MAK" onclick="ripple(event)"><span class="label">MOVIES-1</span></a>
          <a href="https://archive.org/details/DM_MOVIES_PT2_MAK" onclick="ripple(event)"><span class="label">MOVIES-2</span></a>
        </div>
      </div>
    </div>

  <h1 class="heading section-gap">Ben 10</h1>

    <!-- B10: Top series buttons (2 rows x 2 cols) -->
    <div class="grid menu-grid">
      <a class="menu-btn" href="#" onclick="toggleB10(event, 'b10-classic')"><span class="label">Classic</span></a>
      <a class="menu-btn" href="#" onclick="toggleB10(event, 'b10-af')"><span class="label">Alien Force</span></a>
      <a class="menu-btn" href="#" onclick="toggleB10(event, 'b10-ua')"><span class="label">Ultimate Alien</span></a>
      <a class="menu-btn" href="#" onclick="toggleB10(event, 'b10-ov')"><span class="label">Omniverse</span></a>
    </div>

    <div class="panel-wrap">
      <!-- B10: Classic -->
      <div id="b10-classic" class="grid panel b10-panel">
        <a href="https://archive.org/details/B10_CL_S01_MAK" onclick="ripple(event)"><span class="label">CL_S1</span></a>
        <a href="https://archive.org/details/B10_CL_S02_MAK" onclick="ripple(event)"><span class="label">CL_S2</span></a>
        <a href="https://archive.org/details/B10_CL_S03_MAK" onclick="ripple(event)"><span class="label">CL_S3</span></a>
        <a href="https://archive.org/details/B10_CL_S04_MAK" onclick="ripple(event)"><span class="label">CL_S4</span></a>
      </div>

      <!-- B10: Alien Force -->
      <div id="b10-af" class="grid panel b10-panel grid-three-items">
        <a href="https://archive.org/details/B10_AF_S01_MAK" onclick="ripple(event)"><span class="label">AF_S1</span></a>
        <a href="https://archive.org/details/B10_AF_S02_MAK" onclick="ripple(event)"><span class="label">AF_S2</span></a>
        <a href="https://archive.org/details/B10_AF_S03_MAK" onclick="ripple(event)"><span class="label">AF_S3</span></a>
      </div>

      <!-- B10: Ultimate Alien -->
      <div id="b10-ua" class="grid panel b10-panel grid-three-items">
        <a href="https://archive.org/details/B10_UA_S01_MAK" onclick="ripple(event)"><span class="label">UA_S1</span></a>
        <a href="https://archive.org/details/B10_UA_S02_MAK" onclick="ripple(event)"><span class="label">UA_S2</span></a>
        <a href="https://archive.org/details/B10_UA_S03_MAK" onclick="ripple(event)"><span class="label">UA_S3</span></a>
      </div>

      <!-- B10: Omniverse -->
      <div id="b10-ov" class="grid panel b10-panel">
        <a href="https://archive.org/details/B10_OV_S01_MAK" onclick="ripple(event)"><span class="label">OV_S1</span></a>
        <a href="https://archive.org/details/B10_OV_S02_MAK" onclick="ripple(event)"><span class="label">OV_S2</span></a>
        <a href="https://archive.org/details/B10_OV_S03_MAK" onclick="ripple(event)"><span class="label">OV_S3</span></a>
        <a href="https://archive.org/details/B10_OV_S04_MAK" onclick="ripple(event)"><span class="label">OV_S4</span></a>
        <a href="https://archive.org/details/B10_OV_S05_MAK" onclick="ripple(event)"><span class="label">OV_S5</span></a>
        <a href="https://archive.org/details/B10_OV_S06_MAK" onclick="ripple(event)"><span class="label">OV_S6</span></a>
        <a href="https://archive.org/details/B10_OV_S07_MAK" onclick="ripple(event)"><span class="label">OV_S7</span></a>
        <a href="https://archive.org/details/B10_OV_S08_MAK" onclick="ripple(event)"><span class="label">OV_S8</span></a>
      </div>
    </div>

    <h1 class="heading section-gap">Progress Tracker</h1>

    <div style="text-align:center; margin-top:-0.8rem; opacity:0.8;" id="syncStatus">
      Sync: OFF (local only)
    </div>

    <div class="tools-wrap">
      <div class="tool-card">
        <h2 class="tool-title">Sync</h2>
        <div class="tool-row">
          <div class="tool-field">
            <input id="roomInput" class="tool-input" type="text" placeholder="Example: Asim123">
          </div>
          <div class="tool-field">
            <button class="save-btn" id="roomSaveBtn" type="button">Save Room Code</button>
          </div>
        </div>
      </div>

      <div class="tool-card">
        <h2 class="tool-title">Profile</h2>
        <div class="seg" id="profileSeg">
          <button type="button" data-profile="Asim">Asim</button>
          <button type="button" data-profile="Marwa">Marwa</button>
        </div>
      </div>

      <div class="tool-card">
        <h2 class="tool-title">Mode</h2>
        <div class="seg" id="modeSeg">
          <button type="button" data-mode="save">Save</button>
          <button type="button" data-mode="recent">Recent Activity</button>
        </div>

        <div id="savePanel">
          <div class="tool-row" style="margin-top:0.7rem;">
            <div class="tool-field">
              <div class="tool-label">Cartoon</div>
              <select id="cartoonSelect" class="tool-select"></select>
            </div>

            <div class="tool-field" id="seriesField">
              <div class="tool-label">Series</div>
              <select id="seriesSelect" class="tool-select"></select>
            </div>
          </div>

          <div class="tool-row" style="margin-top:0.7rem;">
            <div class="tool-field">
              <div class="tool-label">Type</div>
              <select id="typeSelect" class="tool-select">
                <option value="season">Season</option>
                <option value="movie">Movies</option>
              </select>
            </div>

            <div class="tool-field">
              <div class="tool-label" id="seasonLabel">Season</div>
              <select id="seasonOrMovieSelect" class="tool-select"></select>
            </div>
          </div>

          <div class="save-row">
            <div class="tool-field">
              <div class="tool-label">Episode / Movie Number</div>
              <select id="numSelect" class="tool-select"></select>
            </div>

            <div class="tool-field">
              <div class="tool-label">Actions</div>
              <button class="save-btn" id="saveBtn" type="button">Save</button>
            </div>
          </div>

          <div class="tool-mini" id="saveHint"></div>
        </div>

        <div id="recentPanel" class="hidden">
          <div class="tool-row" style="margin-top:0.7rem;">
            <div class="tool-field">
              <div class="tool-label">Cartoon</div>
              <select id="recentCartoonSelect" class="tool-select"></select>
            </div>
            <div class="tool-field">
              <div class="tool-label">Info</div>
              <div class="tool-mini" id="recentInfo">Select a cartoon to view full activity.</div>
            </div>
          </div>

          <div class="activity-list" id="activityList"></div>
        </div>

      </div>
    </div>
  </main>

  <script>
    // PERFORMANCE OPTIMIZATIONS APPLIED:
    // 1. Debounced resize event
    // 2. Optimized DOM queries and caching
    // 3. Reduced forced reflows
    // 4. Memory leak prevention
    // 5. Efficient event delegation
    // 6. Batch DOM operations

    /* ===== Debounce utility ===== */
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    /* ===== Throttle utility ===== */
    function throttle(func, limit) {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      };
    }

    /* ===== Smooth panel animation (optimized) ===== */
    let panelAnimations = new Map(); // Cache for panel heights
    
    function calculatePanelHeight(panel) {
      if (!panel) return 0;
      
      // Use cached height if available
      if (panelAnimations.has(panel)) {
        return panelAnimations.get(panel);
      }
      
      // Temporarily make visible to measure
      const originalStyle = {
        display: panel.style.display,
        visibility: panel.style.visibility,
        position: panel.style.position
      };
      
      panel.style.display = 'block';
      panel.style.visibility = 'hidden';
      panel.style.position = 'absolute';
      
      const height = panel.scrollHeight;
      
      // Restore original styles
      Object.assign(panel.style, originalStyle);
      
      // Cache the height
      panelAnimations.set(panel, height);
      
      return height;
    }

    function setPanelOpen(panel, open){
      if(!panel) return;

      if(open){
        panel.classList.add('open');
        
        // Use requestAnimationFrame for smooth animation
        requestAnimationFrame(() => {
          // Reset then measure for smooth transition
          panel.style.maxHeight = '0px';
          
          requestAnimationFrame(() => {
            const target = calculatePanelHeight(panel);
            panel.style.maxHeight = target + 'px';
          });
        });
      } else {
        // Get current height
        const current = panel.scrollHeight;
        panel.style.maxHeight = current + 'px';
        
        requestAnimationFrame(() => {
          panel.style.maxHeight = '0px';
          setTimeout(() => {
            panel.classList.remove('open');
          }, 320); // Match CSS transition duration
        });
      }
    }

    function closeAllPanels(selector){
      const panels = document.querySelectorAll(selector);
      for (let i = 0; i < panels.length; i++) {
        setPanelOpen(panels[i], false);
      }
    }

    function toggleGroup(e, targetId, groupSelector){
      if (e) e.preventDefault();
      const target = document.getElementById(targetId);
      if(!target) return;

      const isOpen = target.classList.contains('open');

      // close all in the group first
      closeAllPanels(groupSelector);

      // open only if it was closed
      if(!isOpen) setPanelOpen(target, true);

      if (e) ripple(e);
    }

    function toggleDM(e, targetId){
      toggleGroup(e, targetId, '.dm-panel');
    }

    function toggleB10(e, targetId){
      toggleGroup(e, targetId, '.b10-panel');
    }

    // Debounced resize handler
    const handleResize = debounce(() => {
      const openPanels = document.querySelectorAll('.panel.open');
      for (let i = 0; i < openPanels.length; i++) {
        const panel = openPanels[i];
        // Clear cache and recalculate
        panelAnimations.delete(panel);
        const height = calculatePanelHeight(panel);
        panel.style.maxHeight = height + 'px';
      }
    }, 150);

    // Throttled scroll handler
    const handleScroll = throttle(() => {
      // Add any scroll-based optimizations here
    }, 100);

    // Add optimized event listeners
    window.addEventListener('resize', handleResize);
    window.addEventListener('scroll', handleScroll, { passive: true });

    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://tdpyeauwzdktfihqqyxc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WhASrKnpqODlxsod-B1AhQ___lLXnpe";
    const TABLE_NAME = "toonie_progress";

    const ROOM_KEY  = "toonie_room_code_v1";
    const STORE_KEY = "toonie_progress_tracker_v2";

    const SYNC_POLL_MS = 15000; // Increased from 10000 to reduce network calls

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MODEL = {
      "Doraemon": {
        label: "DM",
        hasSeries: false,
        seasons: ["S1","S2","S3","S4","S5","S6","S7","S8","S12","S14","S15","S16","S17","S18","S19","S20"],
        hasMovies: true
      },
      "Ben 10": {
        label: "B10",
        hasSeries: true,
        series: ["Classic","Alien Force","Ultimate Alien","Omniverse"],
        seasonsBySeries: {
          "Classic": ["S1","S2","S3","S4"],
          "Alien Force": ["S1","S2","S3"],
          "Ultimate Alien": ["S1","S2","S3"],
          "Omniverse": ["S1","S2","S3","S4","S5","S6","S7","S8"]
        },
        hasMovies: true
      }
    };

    // =========================
    // UI HELPERS (OPTIMIZED)
    // =========================
    function setSyncStatus(text) {
      const el = document.getElementById("syncStatus");
      if (el) el.textContent = text;
    }

    // Optimized ripple with requestAnimationFrame
    function ripple(e) {
      if (navigator.vibrate) {
        try { navigator.vibrate(20); } catch(e) {}
      }
      
      const target = e.currentTarget;
      if(!target) return;

      // Create ripple only if needed
      if (target.querySelector('.ripple')) return;

      const rect = target.getBoundingClientRect();
      const cx = (typeof e.clientX === 'number' && e.clientX !== 0) ? e.clientX : (rect.left + rect.width / 2);
      const cy = (typeof e.clientY === 'number' && e.clientY !== 0) ? e.clientY : (rect.top + rect.height / 2);

      const rp = document.createElement('span');
      rp.classList.add('ripple');
      
      // Use smaller size for performance
      const size = Math.max(target.offsetWidth, target.offsetHeight) * 0.8;
      rp.style.width = rp.style.height = size + 'px';
      rp.style.left = cx - rect.left - size / 2 + 'px';
      rp.style.top = cy - rect.top - size / 2 + 'px';
      
      target.appendChild(rp);
      
      // Remove after animation completes
      setTimeout(() => {
        if (rp.parentNode === target) {
          target.removeChild(rp);
        }
      }, 1000);
    }

    // Optimized boot sequence
    let bootTimeout;
    const bootStart = performance.now();
    
    function initBoot() {
      const MIN_SHOW = 1500; // Hardcoded for performance
      const elapsed = performance.now() - bootStart;
      const wait = Math.max(0, MIN_SHOW - elapsed);

      bootTimeout = setTimeout(() => {
        const b = document.getElementById('boot');
        if (b) {
          b.classList.add('hide');
          document.body.classList.add('boot-done');
          
          // Remove from DOM after animation
          setTimeout(() => {
            if (b.parentNode) {
              b.parentNode.removeChild(b);
            }
            // Start animations after boot
            document.querySelectorAll('.heading, .tool-title, a span.label').forEach(el => {
              if (el.style) el.style.animationPlayState = 'running';
            });
          }, 800);
        }
        
        // Clear timeout reference
        bootTimeout = null;
      }, wait);
    }

    // Clean up on page hide
    window.addEventListener('pagehide', () => {
      if (bootTimeout) {
        clearTimeout(bootTimeout);
        bootTimeout = null;
      }
    });

    window.addEventListener('load', initBoot);

    // =========================
    // STORAGE (OPTIMIZED)
    // =========================
    function getRoomCode() {
      return (localStorage.getItem(ROOM_KEY) || "").trim();
    }

    function setRoomCode(code) {
      const clean = String(code || "").trim();
      if (clean) {
        localStorage.setItem(ROOM_KEY, clean);
      } else {
        localStorage.removeItem(ROOM_KEY);
      }
      return clean;
    }

    function nowISO(){
      return new Date().toISOString();
    }

    // Cached date formatter for performance
    let dateFormatter;
    function getDateFormatter() {
      if (!dateFormatter) {
        dateFormatter = new Intl.DateTimeFormat(undefined, {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });
      }
      return dateFormatter;
    }

    function displayLocal(ts){
      if(!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts).slice(0,16);

      const fmt = getDateFormatter();
      const parts = fmt.formatToParts(d).reduce((acc, p) => {
        acc[p.type] = p.value;
        return acc;
      }, {});
      return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}`;
    }

    // Normalize seriesLabel: keep local as null (never "-")
    function normalizeSeriesLocal(x){
      if (x == null) return null;
      const v = String(x).trim();
      if(!v || v === "-") return null;
      return v;
    }

    function ensurePath(store, profile, cartoonLabel){
      if(!store.data[profile][cartoonLabel]){
        store.data[profile][cartoonLabel] = { last: null, history: [] };
      }
      if(!store.data[profile][cartoonLabel].history){
        store.data[profile][cartoonLabel].history = [];
      }
      return store.data[profile][cartoonLabel];
    }

    // Optimized store normalization
    function normalizeAndDedupeStore(store){
      const profiles = ["Asim","Marwa"];
      for(const p of profiles){
        if(!store.data[p]) store.data[p] = {};
        const profileData = store.data[p];
        
        for(const cartoonLabel of Object.keys(profileData)){
          const node = ensurePath(store, p, cartoonLabel);

          if(node.last){
            node.last.seriesLabel = normalizeSeriesLocal(node.last.seriesLabel);
          }

          // Use Map for deduplication (faster than array operations)
          const map = new Map();
          const arr = Array.isArray(node.history) ? node.history : [];
          
          for(let i = 0; i < arr.length; i++){
            const it = arr[i];
            if(!it) continue;
            it.seriesLabel = normalizeSeriesLocal(it.seriesLabel);
            const key = `${it.type}|${it.seasonOrMovie}|${it.seriesLabel || ""}`;
            const prev = map.get(key);
            if(!prev || (String(it.ts) > String(prev.ts))){
              map.set(key, it);
            }
          }

          const merged = Array.from(map.values())
            .sort((a,b) => String(b.ts).localeCompare(String(a.ts)));

          node.history = merged;

          // Update last if needed
          if(merged.length > 0){
            const latest = merged[0];
            if(!node.last || String(latest.ts) > String(node.last.ts)){
              node.last = latest;
            }
          }
        }
      }
      return store;
    }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw){
          return normalizeAndDedupeStore({ activeProfile: "Asim", data: { Asim: {}, Marwa: {} } });
        }
        const obj = JSON.parse(raw);
        if(!obj.data) obj.data = { Asim: {}, Marwa: {} };
        if(!obj.data.Asim) obj.data.Asim = {};
        if(!obj.data.Marwa) obj.data.Marwa = {};
        if(!obj.activeProfile) obj.activeProfile = "Asim";
        return normalizeAndDedupeStore(obj);
      } catch {
        return normalizeAndDedupeStore({ activeProfile: "Asim", data: { Asim: {}, Marwa: {} } });
      }
    }

    function saveStore(store){
      try {
        localStorage.setItem(STORE_KEY, JSON.stringify(store));
      } catch (e) {
        console.warn("Failed to save store:", e);
      }
    }

    function formatLine(entry){
      const parts = [entry.cartoonLabel];
      if(entry.seriesLabel) parts.push(entry.seriesLabel);
      
      if(entry.type === "season"){
        parts.push(entry.seasonOrMovie, `EP ${entry.num}`);
      } else {
        parts.push("MOVIES", `M${entry.num}`);
      }
      return parts.join(" ");
    }

    function upsertEntry(store, profile, entry){
      const node = ensurePath(store, profile, entry.cartoonLabel);
      entry.seriesLabel = normalizeSeriesLocal(entry.seriesLabel);

      if(!node.last || String(entry.ts) >= String(node.last.ts)){
        node.last = entry;
      }

      const keySeries = entry.seriesLabel || null;
      const history = node.history;
      
      // Find existing entry
      let foundIndex = -1;
      for(let i = 0; i < history.length; i++){
        const h = history[i];
        if(h.type === entry.type && 
           h.seasonOrMovie === entry.seasonOrMovie && 
           normalizeSeriesLocal(h.seriesLabel) === keySeries){
          foundIndex = i;
          break;
        }
      }

      if(foundIndex >= 0){
        const old = history[foundIndex];
        if(!old || String(entry.ts) >= String(old.ts)){
          history[foundIndex] = entry;
        }
      } else {
        history.unshift(entry);
      }

      // Keep sorted (newest first)
      history.sort((a,b) => String(b.ts).localeCompare(String(a.ts)));
      
      // Limit history size to prevent memory issues
      if (history.length > 50) {
        node.history = history.slice(0, 50);
      }
    }

    // =========================
    // SUPABASE HELPERS (OPTIMIZED)
    // =========================
    function supabaseEnabled(){
      return !!(SUPABASE_URL && SUPABASE_ANON_KEY && supabaseClient);
    }

    async function sbUpsertProgress(row){
      const room = getRoomCode();
      if(!room) return { ok: false, skipped: true };

      const cloudSeries = (row.series_label == null || String(row.series_label).trim() === "")
        ? "-"
        : String(row.series_label);

      const payload = {
        room_code: room,
        profile: row.profile,
        cartoon_label: row.cartoon_label,
        series_label: cloudSeries,
        type: row.type,
        season_or_movie: row.season_or_movie,
        num: Number(row.num) || 0,
        ts: row.ts
      };

      try {
        const { error } = await supabaseClient
          .from(TABLE_NAME)
          .upsert(payload, {
            onConflict: "room_code,profile,cartoon_label,series_label,type,season_or_movie"
          });

        if(error){
          console.error("Cloud upsert error:", error);
          return { ok: false, error: error.message || "Cloud upsert failed" };
        }
        return { ok: true };
      } catch (error) {
        console.error("Cloud upsert exception:", error);
        return { ok: false, error: "Network error" };
      }
    }

    async function sbFetchProgress(room, profile, limit = 100){ // Reduced from 250
      if(!room) return { ok: false, skipped: true, rows: [] };

      try {
        const { data, error } = await supabaseClient
          .from(TABLE_NAME)
          .select("room_code,profile,cartoon_label,series_label,type,season_or_movie,num,ts")
          .eq("room_code", room)
          .eq("profile", profile)
          .order("ts", { ascending: false })
          .limit(limit);

        if(error){
          console.error("Cloud fetch error:", error);
          return { ok: false, error: error.message || "Cloud fetch failed", rows: [] };
        }
        return { ok: true, rows: data || [] };
      } catch (error) {
        console.error("Cloud fetch exception:", error);
        return { ok: false, error: "Network error", rows: [] };
      }
    }

    // =========================
    // APP (OPTIMIZED)
    // =========================
    function initTracker(){
      // Cache DOM elements
      const profileSeg = document.getElementById("profileSeg");
      const modeSeg = document.getElementById("modeSeg");
      const savePanel = document.getElementById("savePanel");
      const recentPanel = document.getElementById("recentPanel");
      const cartoonSelect = document.getElementById("cartoonSelect");
      const seriesField = document.getElementById("seriesField");
      const seriesSelect = document.getElementById("seriesSelect");
      const typeSelect = document.getElementById("typeSelect");
      const seasonLabel = document.getElementById("seasonLabel");
      const seasonOrMovieSelect = document.getElementById("seasonOrMovieSelect");
      const numSelect = document.getElementById("numSelect");
      const saveBtn = document.getElementById("saveBtn");
      const saveHint = document.getElementById("saveHint");
      const recentCartoonSelect = document.getElementById("recentCartoonSelect");
      const recentInfo = document.getElementById("recentInfo");
      const activityList = document.getElementById("activityList");
      const roomInput = document.getElementById("roomInput");
      const roomSaveBtn = document.getElementById("roomSaveBtn");

      if(!profileSeg || !modeSeg) return;

      let store = loadStore();
      saveStore(store); // Initial save to clean data

      let activeProfile = store.activeProfile || "Asim";
      let activeMode = "save";
      let pollTimer = null;
      let lastCloudOk = true;
      let isSaving = false; // Prevent double saves

      // Optimized vibrate
      function vib(){ 
        if (navigator.vibrate && !isSaving) {
          try { navigator.vibrate(15); } catch(e) {} // Reduced duration
        }
      }

      function refreshRoomUI(){
        const room = getRoomCode();
        if(roomInput) roomInput.value = room;

        if(!room){
          setSyncStatus("Sync: OFF (local only)");
          return;
        }

        if(!supabaseEnabled()){
          setSyncStatus(`Sync: OFF (Room: ${room})`);
          return;
        }

        setSyncStatus(`Sync: ON (Room: ${room})`);
      }

      function setProfileUI(){
        const buttons = profileSeg.querySelectorAll("button");
        for (let i = 0; i < buttons.length; i++) {
          buttons[i].classList.toggle("active", buttons[i].dataset.profile === activeProfile);
        }
      }

      function setModeUI(){
        const buttons = modeSeg.querySelectorAll("button");
        for (let i = 0; i < buttons.length; i++) {
          buttons[i].classList.toggle("active", buttons[i].dataset.mode === activeMode);
        }

        if(activeMode === "save"){
          savePanel.classList.remove("hidden");
          recentPanel.classList.add("hidden");
        } else {
          savePanel.classList.add("hidden");
          recentPanel.classList.remove("hidden");
          renderRecent();
        }
      }

      function cartoonsList(){ return ["Doraemon", "Ben 10"]; } // Hardcoded for performance
      function getCartoonCfg(name){ return MODEL[name]; }

      // Cached options HTML
      let cartoonOptionsHtml = null;
      function fillCartoonSelects(){
        if (!cartoonOptionsHtml) {
          cartoonOptionsHtml = cartoonsList().map(c => `<option value="${c}">${c}</option>`).join("");
        }
        cartoonSelect.innerHTML = cartoonOptionsHtml;
        recentCartoonSelect.innerHTML = cartoonOptionsHtml;
      }

      function fillSeries(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(!cfg || !cfg.hasSeries){
          seriesField.classList.add("hidden");
          seriesSelect.innerHTML = "";
          return;
        }
        seriesField.classList.remove("hidden");
        
        // Cache series options
        if (!cfg._seriesOptionsHtml) {
          cfg._seriesOptionsHtml = cfg.series.map(s => `<option value="${s}">${s}</option>`).join("");
        }
        seriesSelect.innerHTML = cfg._seriesOptionsHtml;
      }

      function fillSeasonOrMovie(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        const type = typeSelect.value;

        if(type === "movie"){
          seasonLabel.textContent = "Movies";
          seasonOrMovieSelect.innerHTML = `<option value="Movies">Movies</option>`;
          return;
        }

        seasonLabel.textContent = "Season";

        let seasons = [];
        if(cfg.hasSeries){
          const s = seriesSelect.value;
          seasons = (cfg.seasonsBySeries && cfg.seasonsBySeries[s]) ? cfg.seasonsBySeries[s] : [];
        } else {
          seasons = cfg.seasons || [];
        }

        seasonOrMovieSelect.innerHTML = seasons.map(x => `<option value="${x}">${x}</option>`).join("");
      }

      // Pre-render episode options for performance
      let episodeOptionsHtml = null;
      function fillEpisodeDropdown(max = 100){
        if (!episodeOptionsHtml) {
          let html = "";
          for(let i = 1; i <= max; i++){
            html += `<option value="${i}">${i}</option>`;
          }
          episodeOptionsHtml = html;
        }
        numSelect.innerHTML = episodeOptionsHtml;
        numSelect.value = "1";
      }

      function currentKeyLabels(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        const cartoonLabel = cfg.label;
        const type = typeSelect.value;
        let seriesLabel = null;

        if(cfg.hasSeries){
          const s = seriesSelect.value;
          seriesLabel = (s === "Classic") ? "CL" :
                        (s === "Alien Force") ? "AF" :
                        (s === "Ultimate Alien") ? "UA" :
                        (s === "Omniverse") ? "OV" : s;
        }

        const seasonOrMovie = seasonOrMovieSelect.value;

        return { cartoonLabel, seriesLabel, type, seasonOrMovie };
      }

      function updateSaveHintForCartoon(){
        store = loadStore();
        const cfg = getCartoonCfg(cartoonSelect.value);
        const cartoonLabel = cfg.label;
        const node = ensurePath(store, activeProfile, cartoonLabel);

        if(node.last){
          saveHint.textContent = `Last: ${formatLine(node.last)} (${displayLocal(node.last.ts)})`;
        } else {
          saveHint.textContent = "No activity yet for this cartoon.";
        }
      }

      // Optimized render with document fragment
      function renderRecent(){
        store = loadStore();
        const cartoonName = recentCartoonSelect.value;
        const cfg = getCartoonCfg(cartoonName);
        const cartoonLabel = cfg.label;

        const node = ensurePath(store, activeProfile, cartoonLabel);
        const list = node.history || [];

        if(list.length === 0){
          recentInfo.textContent = "No activity yet.";
          activityList.innerHTML = "";
          return;
        }

        recentInfo.textContent = `Showing activity for ${cartoonLabel} (${activeProfile})`;
        
        // Use document fragment for batch DOM updates
        const fragment = document.createDocumentFragment();
        for (let i = 0; i < list.length; i++) {
          const item = list[i];
          const div = document.createElement('div');
          div.className = 'activity-item';
          div.innerHTML = `
            <div>${formatLine(item)}</div>
            <div class="right">${displayLocal(item.ts)}</div>
          `;
          fragment.appendChild(div);
        }
        
        activityList.innerHTML = '';
        activityList.appendChild(fragment);
      }

      // Optimized cloud polling with exponential backoff
      let pollFailCount = 0;
      const MAX_POLL_FAILURES = 3;
      
      async function pollFromCloud(){
        const room = getRoomCode();
        if(!room || !supabaseEnabled()) return;

        const res = await sbFetchProgress(room, activeProfile, 100);
        if(!res.ok){
          pollFailCount++;
          if(pollFailCount >= MAX_POLL_FAILURES) {
            stopPolling();
            setSyncStatus(`Sync: OFF (failed ${MAX_POLL_FAILURES} times)`);
          }
          lastCloudOk = false;
          return;
        }

        pollFailCount = 0;
        lastCloudOk = true;

        store = loadStore();

        const rows = res.rows;
        for(let i = 0; i < rows.length; i++){
          const r = rows[i];
          const entry = {
            cartoonLabel: r.cartoon_label,
            seriesLabel: normalizeSeriesLocal(r.series_label),
            type: r.type,
            seasonOrMovie: r.season_or_movie,
            num: Number(r.num) || 1,
            ts: r.ts
          };
          upsertEntry(store, activeProfile, entry);
        }

        store = normalizeAndDedupeStore(store);
        saveStore(store);

        updateSaveHintForCartoon();
        if(activeMode === "recent") renderRecent();
      }

      function startPolling(){
        stopPolling();
        const room = getRoomCode();
        if(!room || !supabaseEnabled()) return;

        pollTimer = setInterval(() => {
          pollFromCloud().catch(() => {});
        }, SYNC_POLL_MS);

        // Initial poll
        setTimeout(() => pollFromCloud().catch(() => {}), 1000);
      }

      function stopPolling(){
        if(pollTimer){
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }

      // Debounced save function
      const debouncedSave = debounce(async function() {
        if (isSaving) return;
        isSaving = true;
        
        try {
          vib();
          store = loadStore();

          const cur = currentKeyLabels();
          const num = Math.max(1, Math.min(100, Number(numSelect.value) || 1));

          const entry = {
            cartoonLabel: cur.cartoonLabel,
            seriesLabel: normalizeSeriesLocal(cur.seriesLabel),
            type: cur.type,
            seasonOrMovie: cur.seasonOrMovie,
            num,
            ts: nowISO()
          };

          // LOCAL SAVE
          upsertEntry(store, activeProfile, entry);
          store = normalizeAndDedupeStore(store);
          saveStore(store);

          saveHint.textContent = `Saved: ${formatLine(entry)} (${displayLocal(entry.ts)})`;

          // CLOUD SAVE
          const room = getRoomCode();
          if(room && supabaseEnabled()){
            const push = await sbUpsertProgress({
              profile: activeProfile,
              cartoon_label: entry.cartoonLabel,
              series_label: entry.seriesLabel || "-",
              type: entry.type,
              season_or_movie: entry.seasonOrMovie,
              num: entry.num,
              ts: entry.ts
            });

            if(push.ok){
              // Don't immediately poll - let normal polling handle it
            } else {
              saveHint.textContent = `Saved locally. (Cloud: ${push.error || "failed"})`;
            }
          }
        } catch (error) {
          console.error("Save error:", error);
          saveHint.textContent = "Error saving. Please try again.";
        } finally {
          isSaving = false;
        }
      }, 300);

      async function doSave(){
        debouncedSave();
      }

      // ===== INIT =====
      fillCartoonSelects();
      fillSeries();
      fillSeasonOrMovie();
      fillEpisodeDropdown(100);

      setProfileUI();
      setModeUI();

      recentCartoonSelect.value = cartoonSelect.value;

      refreshRoomUI();
      updateSaveHintForCartoon();
      startPolling();

      // ===== OPTIMIZED EVENT HANDLERS =====
      
      // Event delegation for profile buttons
      profileSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        
        activeProfile = btn.dataset.profile;
        store = loadStore();
        store.activeProfile = activeProfile;
        saveStore(store);

        setProfileUI();
        updateSaveHintForCartoon();
        if(activeMode === "recent") renderRecent();
        startPolling();
      });

      // Event delegation for mode buttons
      modeSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        
        activeMode = btn.dataset.mode;
        setModeUI();
      });

      // Debounced change handlers
      const debouncedFillSeries = debounce(fillSeries, 50);
      const debouncedUpdateHint = debounce(updateSaveHintForCartoon, 100);
      const debouncedFillSeason = debounce(fillSeasonOrMovie, 50);

      cartoonSelect.addEventListener("change", () => {
        debouncedFillSeries();
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(!cfg.hasMovies) typeSelect.value = "season";

        debouncedFillSeason();
        debouncedUpdateHint();

        recentCartoonSelect.value = cartoonSelect.value;
        if(activeMode === "recent") renderRecent();
      });

      seriesSelect.addEventListener("change", () => {
        debouncedFillSeason();
        debouncedUpdateHint();
      });

      typeSelect.addEventListener("change", () => {
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(typeSelect.value === "movie" && !cfg.hasMovies) typeSelect.value = "season";
        debouncedFillSeason();
        debouncedUpdateHint();
      });

      seasonOrMovieSelect.addEventListener("change", () => {
        debouncedUpdateHint();
      });

      saveBtn.addEventListener("click", (e) => { 
        e.preventDefault();
        doSave().catch(() => {}); 
      });

      recentCartoonSelect.addEventListener("change", debounce(renderRecent, 100));

      if(roomSaveBtn && roomInput){
        roomSaveBtn.addEventListener("click", () => {
          const code = (roomInput.value || "").trim();
          setRoomCode(code);
          refreshRoomUI();
          startPolling();
        });
      }

      if(roomInput){
        roomInput.addEventListener("keydown", (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
            if(roomSaveBtn) roomSaveBtn.click();
          }
        });
      }
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        stopPolling();
        panelAnimations.clear();
      });
    }

    // Defer initialization
    window.addEventListener("load", () => {
      // Wait for boot to complete
      setTimeout(initTracker, 500);
    });
  </script>
</body>
</html>
