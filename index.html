<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toonie</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/192.png" type="image/png" sizes="192x192">
  <link rel="icon" href="icons/512.png" type="image/png" sizes="512x512">

  <meta name="theme-color" content="#121212">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Toonie">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- room-ish Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Boot */
      --boot-min-show: 900ms;
      --boot-fade: 350ms;
      --app-fade: 250ms;
      --app-fade-delay: 80ms;

      /* ===== Material 3 dark-ish token set (hand-tuned) ===== */
      --md-bg: #121212;
      --md-surface: #1E1E1E;
      --md-surface-2: #232323;
      --md-surface-3: #2A2A2A;

      --md-outline: rgba(255,255,255,0.12);
      --md-outline-strong: rgba(255,255,255,0.16);

      --md-text: rgba(255,255,255,0.92);
      --md-text-soft: rgba(255,255,255,0.70);
      --md-text-faint: rgba(255,255,255,0.54);

      /* Material 3-ish purple in dark theme */
      --md-primary: #D0BCFF;
      --md-on-primary: #2B1B5A;

      --md-secondary: #CCC2DC;
      --md-on-secondary: #2B2637;

      --md-tertiary: #EFB8C8;
      --md-on-tertiary: #3A1A26;

      --md-error: #F2B8B5;
      --md-on-error: #601410;

      /* Shape */
      --md-radius-xs: 10px;
      --md-radius-sm: 12px;
      --md-radius-md: 16px;
      --md-radius-lg: 20px;
      --md-pill: 999px;

      /* Elevation */
      --e1: 0 1px 2px rgba(0,0,0,0.55), 0 1px 1px rgba(0,0,0,0.35);
      --e2: 0 4px 10px rgba(0,0,0,0.55), 0 1px 2px rgba(0,0,0,0.35);
      --e3: 0 10px 22px rgba(0,0,0,0.60), 0 2px 4px rgba(0,0,0,0.40);

      /* Motion */
      --t-fast: 140ms;
      --t-med: 200ms;
      --t-slow: 320ms;

      /* Layout */
      --max: 920px;
    }

    *{ box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: var(--md-bg);
      color: var(--md-text);
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Boot */
    #boot {
      position: fixed;
      inset: 0;
      background: var(--md-bg);
      z-index: 9999;
      opacity: 1;
      transition: opacity var(--boot-fade) ease;
    }
    #boot.hide { opacity: 0; pointer-events: none; }

    /* App fade-in */
    #app {
      opacity: 0;
      transform: translateY(4px);
      transition:
        opacity var(--app-fade) ease var(--app-fade-delay),
        transform var(--app-fade) ease var(--app-fade-delay);
      padding-bottom: 36px;
    }
    .boot-done #app { opacity: 1; transform: translateY(0); }

    /* ===== Top App Bar (Material-ish) ===== */
    .appbar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(18,18,18,0.94);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--md-outline);
    }

    .appbar-inner{
      max-width: var(--max);
      margin: 0 auto;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .brand{
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .brand-title{
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.15px;
      line-height: 1.2;
      margin: 0;
    }

    .brand-sub{
      font-size: 12px;
      color: var(--md-text-soft);
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70vw;
    }

    /* ===== Section titles ===== */
    .section{
      max-width: var(--max);
      margin: 0 auto;
      padding: 18px 16px 8px;
    }

    .section-title{
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.1px;
    }

    .section-hint{
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--md-text-soft);
      line-height: 1.45;
    }

    /* ===== Cards ===== */
    .card{
      background: var(--md-surface);
      border: 1px solid var(--md-outline);
      border-radius: var(--md-radius-lg);
      box-shadow: var(--e1);
      padding: 14px;
    }

    .card + .card{ margin-top: 12px; }

    .card-title{
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: var(--md-text);
    }

    /* ===== Buttons (Material-ish) ===== */
    .md-btn{
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      height: 40px;
      padding: 0 16px;
      border-radius: var(--md-pill);
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.1px;
      text-decoration: none;
      cursor: pointer;
      border: 1px solid transparent;
      outline: none;
      position: relative;
      overflow: hidden;
      transition:
        transform var(--t-fast) ease,
        box-shadow var(--t-fast) ease,
        filter var(--t-fast) ease,
        background-color var(--t-fast) ease,
        border-color var(--t-fast) ease;
      box-shadow: none;
      color: var(--md-text);
      background: var(--md-surface-2);
    }

    .md-btn:active{
      transform: translateY(1px);
      filter: brightness(1.02);
    }

    .md-btn:hover{
      filter: brightness(1.05);
    }

    .md-filled{
      background: var(--md-primary);
      color: var(--md-on-primary);
      border-color: transparent;
      box-shadow: var(--e1);
    }

    .md-tonal{
      background: rgba(208,188,255,0.16);
      color: var(--md-primary);
      border-color: rgba(208,188,255,0.28);
    }

    .md-outlined{
      background: transparent;
      border-color: var(--md-outline-strong);
      color: var(--md-text);
    }

    .md-danger{
      background: rgba(242,184,181,0.14);
      border-color: rgba(242,184,181,0.25);
      color: var(--md-error);
    }

    /* Ripple */
    .md-btn .ripple{
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      animation: ripple 520ms ease-out;
      background: rgba(255,255,255,0.30);
      pointer-events: none;
      mix-blend-mode: overlay;
    }
    @keyframes ripple{
      to { transform: scale(3.8); opacity: 0; }
    }

    /* ===== Grid for season buttons ===== */
    .grid{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      width: 100%;
    }
    @media (min-width: 560px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (min-width: 860px){
      .grid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }

    /* Menu row */
    .menu-row{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    /* Make grid items stretch nicely */
    .grid .md-btn{
      width: 100%;
      height: 44px;
      border-radius: var(--md-radius-md);
      justify-content: center;
    }

    /* Movies grid */
    .grid-2{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 420px){
      .grid-2{ grid-template-columns: 1fr; }
    }

    /* ===== Panels (your existing open/close logic) ===== */
    .panel{
      overflow: hidden;
      margin: 0;
      padding: 0;
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
      transition:
        max-height 420ms cubic-bezier(.2,.9,.2,1),
        opacity 220ms ease,
        transform 220ms ease;
      display: none;

      will-change: max-height, opacity, transform;
    }
   .panel.open{
  display: block;   /* ðŸ”¥ bring it back only when open */
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
  margin-top: 14px;
}


    /* ===== Progress tracker (Material-ish form styling) ===== */
    .form-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: end;
    }
    @media (max-width: 700px){
      .form-row{ grid-template-columns: 1fr; }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }

    .label{
      font-size: 12px;
      color: var(--md-text-soft);
      letter-spacing: 0.2px;
    }

    .input, .select{
      width: 100%;
      height: 44px;
      border-radius: var(--md-radius-md);
      border: 1px solid var(--md-outline);
      background: var(--md-surface-2);
      color: var(--md-text);
      padding: 0 12px;
      font-size: 14px;
      outline: none;
      transition: border-color var(--t-fast) ease, box-shadow var(--t-fast) ease, filter var(--t-fast) ease;
    }

    .input:focus, .select:focus{
      border-color: rgba(208,188,255,0.55);
      box-shadow: 0 0 0 3px rgba(208,188,255,0.12);
      filter: brightness(1.02);
    }

    .seg{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .seg .md-btn{
      height: 38px;
      padding: 0 14px;
      border-radius: var(--md-pill);
      background: transparent;
      border-color: var(--md-outline-strong);
      color: var(--md-text);
    }

    .seg .md-btn.active{
      background: rgba(208,188,255,0.16);
      border-color: rgba(208,188,255,0.35);
      color: var(--md-primary);
    }

    .mini{
      font-size: 13px;
      color: var(--md-text-soft);
      line-height: 1.45;
      margin-top: 8px;
    }

    .activity-list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      max-height: 340px;
      overflow:auto;
      padding-right: 4px;
    }

    .activity-item{
      background: var(--md-surface-2);
      border: 1px solid var(--md-outline);
      border-radius: var(--md-radius-md);
      padding: 10px 12px;
      display:flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      box-shadow: var(--e1);
    }

    .activity-item .right{
      color: var(--md-text-faint);
      font-size: 12px;
      white-space: nowrap;
    }

    .hidden{ display:none !important; }

    /* Sync status pill */
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: var(--md-pill);
      background: var(--md-surface-2);
      border: 1px solid var(--md-outline);
      color: var(--md-text-soft);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div id="boot"></div>

  <main id="app">
    <!-- App Bar -->
    <header class="appbar">
      <div class="appbar-inner">
        <div class="brand">
          <p class="brand-title">Toonie</p>
        </div>

        <div id="syncStatus" class="status-pill">Sync: OFF (local only)</div>
      </div>
    </header>

    <!-- Doraemon -->
    <section class="section">
      <h2 class="section-title">Doraemon</h2>

      <div class="card">
        <div class="menu-row">
          <a class="md-btn md-tonal" href="#" onclick="toggleDM(event,'dm-seasons')">Seasons</a>
          <a class="md-btn md-tonal" href="#" onclick="toggleDM(event,'dm-movies')">Movies</a>
        </div>

        <div id="dm-seasons" class="panel dm-panel" style="margin-top:12px;">
          <div class="grid">
            <a class="md-btn md-outlined" href="https://archive.org/details/dm-s1-mak" onclick="ripple(event)">DM_S1</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/doraemon-s2-mak" onclick="ripple(event)">DM_S2</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM-S3-MAK" onclick="ripple(event)">DM_S3</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM-S4-MAK" onclick="ripple(event)">DM_S4</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM-S5-MAK" onclick="ripple(event)">DM_S5</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM-S6-MAK2" onclick="ripple(event)">DM_S6</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM-S7-MAK" onclick="ripple(event)">DM_S7</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM-S8-MAK" onclick="ripple(event)">DM_S8</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM-S12-MAK" onclick="ripple(event)">DM_S12</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM_S14_MAK" onclick="ripple(event)">DM_S14</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM_S15_MAK" onclick="ripple(event)">DM_S15</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM_S16_MAK" onclick="ripple(event)">DM_S16</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM_S17_MAK" onclick="ripple(event)">DM_S17</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM_S18_MAK" onclick="ripple(event)">DM_S18</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM_S19_MAK" onclick="ripple(event)">DM_S19</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/DM_S20_MAK" onclick="ripple(event)">DM_S20</a>
          </div>
        </div>

        <div id="dm-movies" class="panel dm-panel" style="margin-top:12px;">
          <div class="grid-2">
            <a class="md-btn md-filled" href="https://archive.org/details/DM_MOVIES_MAK" onclick="ripple(event)">MOVIES-1</a>
            <a class="md-btn md-filled" href="https://archive.org/details/DM_MOVIES_PT2_MAK" onclick="ripple(event)">MOVIES-2</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Ben 10 -->
    <section class="section">
      <h2 class="section-title">Ben 10</h2>
      
      <div class="card">
        <div class="menu-row">
          <a class="md-btn md-tonal" href="#" onclick="toggleB10(event,'b10-classic')">Classic</a>
          <a class="md-btn md-tonal" href="#" onclick="toggleB10(event,'b10-af')">Alien Force</a>
          <a class="md-btn md-tonal" href="#" onclick="toggleB10(event,'b10-ua')">Ultimate Alien</a>
          <a class="md-btn md-tonal" href="#" onclick="toggleB10(event,'b10-ov')">Omniverse</a>
        </div>

        <div id="b10-classic" class="panel b10-panel" style="margin-top:12px;">
          <div class="grid">
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_CL_S01_MAK" onclick="ripple(event)">CL_S1</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_CL_S02_MAK" onclick="ripple(event)">CL_S2</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_CL_S03_MAK" onclick="ripple(event)">CL_S3</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_CL_S04_MAK" onclick="ripple(event)">CL_S4</a>
          </div>
        </div>

        <div id="b10-af" class="panel b10-panel" style="margin-top:12px;">
          <div class="grid">
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_AF_S01_MAK" onclick="ripple(event)">AF_S1</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_AF_S02_MAK" onclick="ripple(event)">AF_S2</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_AF_S03_MAK" onclick="ripple(event)">AF_S3</a>
          </div>
        </div>

        <div id="b10-ua" class="panel b10-panel" style="margin-top:12px;">
          <div class="grid">
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_UA_S01_MAK" onclick="ripple(event)">UA_S1</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_UA_S02_MAK" onclick="ripple(event)">UA_S2</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_UA_S03_MAK" onclick="ripple(event)">UA_S3</a>
          </div>
        </div>

        <div id="b10-ov" class="panel b10-panel" style="margin-top:12px;">
          <div class="grid">
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S01_MAK" onclick="ripple(event)">OV_S1</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S02_MAK" onclick="ripple(event)">OV_S2</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S03_MAK" onclick="ripple(event)">OV_S3</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S04_MAK" onclick="ripple(event)">OV_S4</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S05_MAK" onclick="ripple(event)">OV_S5</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S06_MAK" onclick="ripple(event)">OV_S6</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S07_MAK" onclick="ripple(event)">OV_S7</a>
            <a class="md-btn md-outlined" href="https://archive.org/details/B10_OV_S08_MAK" onclick="ripple(event)">OV_S8</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Progress Tracker -->
    <section class="section">
      <h2 class="section-title">Progress Tracker</h2>

      <div class="card">
        <p class="card-title">Sync</p>
        <div class="form-row">
          <div class="field">
            <div class="label">Room Code</div>
            <input id="roomInput" class="input" type="text" placeholder="Example: Asim123">
          </div>
          <div class="field">
            <div class="label">Action</div>
            <button class="md-btn md-filled" id="roomSaveBtn" type="button">Save Room Code</button>
          </div>
        </div>
        <div class="mini" id="roomStatus"></div>
      </div>

      <div class="card">
        <p class="card-title">Profile</p>
        <div class="seg" id="profileSeg">
          <button class="md-btn md-outlined" type="button" data-profile="Asim">Asim</button>
          <button class="md-btn md-outlined" type="button" data-profile="Marwa">Marwa</button>
        </div>
      </div>

      <div class="card">
        <p class="card-title">Mode</p>
        <div class="seg" id="modeSeg">
          <button class="md-btn md-outlined" type="button" data-mode="save">Save</button>
          <button class="md-btn md-outlined" type="button" data-mode="recent">Recent Activity</button>
        </div>

        <div id="savePanel" style="margin-top:12px;">
          <div class="form-row">
            <div class="field">
              <div class="label">Cartoon</div>
              <select id="cartoonSelect" class="select"></select>
            </div>

            <div class="field" id="seriesField">
              <div class="label">Series</div>
              <select id="seriesSelect" class="select"></select>
            </div>
          </div>

          <div class="form-row" style="margin-top:12px;">
            <div class="field">
              <div class="label">Type</div>
              <select id="typeSelect" class="select">
                <option value="season">Season</option>
                <option value="movie">Movies</option>
              </select>
            </div>

            <div class="field">
              <div class="label" id="seasonLabel">Season</div>
              <select id="seasonOrMovieSelect" class="select"></select>
            </div>
          </div>

          <div class="form-row" style="margin-top:12px;">
            <div class="field">
              <div class="label">Episode / Movie Number</div>
              <select id="numSelect" class="select"></select>
            </div>

            <div class="field">
              <div class="label">Action</div>
              <button class="md-btn md-filled" id="saveBtn" type="button">Save</button>
            </div>
          </div>

          <div class="mini" id="saveHint"></div>
        </div>

        <div id="recentPanel" class="hidden" style="margin-top:12px;">
          <div class="form-row">
            <div class="field">
              <div class="label">Cartoon</div>
              <select id="recentCartoonSelect" class="select"></select>
            </div>
            <div class="field">
              <div class="label">Info</div>
              <div class="mini" id="recentInfo">Select a cartoon to view full activity.</div>
            </div>
          </div>

          <div class="activity-list" id="activityList"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Smooth panel animation (same logic) ===== */
    function setPanelOpen(panel, open){
      if(!panel) return;

      if(open){
        panel.classList.add('open');
        panel.style.maxHeight = '0px';
        panel.offsetHeight;
        const target = panel.scrollHeight;
        panel.style.maxHeight = target + 'px';
      } else {
        const current = panel.scrollHeight;
        panel.style.maxHeight = current + 'px';
        panel.offsetHeight;
        panel.style.maxHeight = '0px';
        panel.classList.remove('open');
      }
    }

    function toggleGroup(e, targetId, groupSelector){
      e.preventDefault();
      const target = document.getElementById(targetId);
      if(!target) return;

      const isOpen = target.classList.contains('open');
      document.querySelectorAll(groupSelector).forEach(p => setPanelOpen(p, false));
      if(!isOpen) setPanelOpen(target, true);

      ripple(e);
    }

    function toggleDM(e, targetId){ toggleGroup(e, targetId, '.dm-panel'); }
    function toggleB10(e, targetId){ toggleGroup(e, targetId, '.b10-panel'); }

    // keep opened panels correct on resize
    window.addEventListener('resize', () => {
      document.querySelectorAll('.panel.open').forEach(p => {
        p.style.maxHeight = p.scrollHeight + 'px';
      });
    });

    // UI
    function setSyncStatus(text) {
      const el = document.getElementById("syncStatus");
      if (el) el.textContent = text;
    }

    /* room-ish ripple */
    function ripple(e) {
      if (navigator.vibrate) navigator.vibrate(18);

      const target = e.currentTarget;
      if(!target) return;

      // only ripple room buttons/links
      if(!target.classList || !target.classList.contains('md-btn')) return;

      const rect = target.getBoundingClientRect();
      const cx = (typeof e.clientX === 'number' && e.clientX !== 0) ? e.clientX : (rect.left + rect.width / 2);
      const cy = (typeof e.clientY === 'number' && e.clientY !== 0) ? e.clientY : (rect.top + rect.height / 2);

      const rp = document.createElement('span');
      rp.classList.add('ripple');
      const size = Math.max(target.offsetWidth, target.offsetHeight);
      rp.style.width = rp.style.height = (size * 1.2) + 'px';
      rp.style.left = (cx - rect.left - (size*1.2)/2) + 'px';
      rp.style.top = (cy - rect.top - (size*1.2)/2) + 'px';

      target.appendChild(rp);
      setTimeout(() => rp.remove(), 600);
    }

    // Boot overlay fade
    const bootStart = performance.now();
    window.addEventListener('load', () => {
      const MIN_SHOW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--boot-min-show')) || 900;
      const elapsed = performance.now() - bootStart;
      const wait = Math.max(0, MIN_SHOW - elapsed);

      setTimeout(() => {
        const b = document.getElementById('boot');
        if (b) {
          b.classList.add('hide');
          document.body.classList.add('boot-done');
          const bootFade = (parseFloat(getComputedStyle(b).transitionDuration) || 0.35) * 1000;
          setTimeout(() => b.remove(), bootFade + 60);
        }
      }, wait);
    });

    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://tdpyeauwzdktfihqqyxc.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WhASrKnpqODlxsod-B1AhQ___lLXnpe";
    const TABLE_NAME = "toonie_progress";

    const ROOM_KEY  = "toonie_room_code_v1";
    const STORE_KEY = "toonie_progress_tracker_v2";

    const SYNC_POLL_MS = 10000;

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MODEL = {
      "Doraemon": {
        label: "DM",
        hasSeries: false,
        seasons: ["S1","S2","S3","S4","S5","S6","S7","S8","S12","S14","S15","S16","S17","S18","S19","S20"],
        hasMovies: true
      },
      "Ben 10": {
        label: "B10",
        hasSeries: true,
        series: ["Classic","Alien Force","Ultimate Alien","Omniverse"],
        seasonsBySeries: {
          "Classic": ["S1","S2","S3","S4"],
          "Alien Force": ["S1","S2","S3"],
          "Ultimate Alien": ["S1","S2","S3"],
          "Omniverse": ["S1","S2","S3","S4","S5","S6","S7","S8"]
        },
        hasMovies: true
      }
    };

    // =========================
    // STORAGE (ROOM + LOCAL)
    // =========================
    function getRoomCode() {
      return (localStorage.getItem(ROOM_KEY) || "").trim();
    }

    function setRoomCode(code) {
      const clean = String(code || "").trim();
      if (clean) localStorage.setItem(ROOM_KEY, clean);
      else localStorage.removeItem(ROOM_KEY);
      return clean;
    }

    function nowISO(){ return new Date().toISOString(); }

    function displayLocal(ts){
      if(!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return String(ts).slice(0,16);

      const fmt = new Intl.DateTimeFormat(undefined, {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      });

      const parts = fmt.formatToParts(d).reduce((acc, p) => {
        acc[p.type] = p.value;
        return acc;
      }, {});
      return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}`;
    }

    function normalizeSeriesLocal(x){
      const v = (x == null) ? null : String(x).trim();
      if(!v) return null;
      if(v === "-") return null;
      return v;
    }

    function ensurePath(store, profile, cartoonLabel){
      if(!store.data[profile][cartoonLabel]){
        store.data[profile][cartoonLabel] = { last: null, history: [] };
      }
      if(!store.data[profile][cartoonLabel].history){
        store.data[profile][cartoonLabel].history = [];
      }
      return store.data[profile][cartoonLabel];
    }

    function normalizeAndDedupeStore(store){
      const profiles = ["Asim","Marwa"];
      for(const p of profiles){
        if(!store.data[p]) store.data[p] = {};
        for(const cartoonLabel of Object.keys(store.data[p] || {})){
          const node = ensurePath(store, p, cartoonLabel);

          if(node.last){
            node.last.seriesLabel = normalizeSeriesLocal(node.last.seriesLabel);
          }

          const map = new Map();
          const arr = Array.isArray(node.history) ? node.history : [];
          for(const it of arr){
            if(!it) continue;
            it.seriesLabel = normalizeSeriesLocal(it.seriesLabel);
            const key = `${it.type}|${it.seasonOrMovie}|${it.seriesLabel || ""}`;
            const prev = map.get(key);
            if(!prev || (String(it.ts) > String(prev.ts))){
              map.set(key, it);
            }
          }

          const merged = Array.from(map.values())
            .sort((a,b) => String(b.ts).localeCompare(String(a.ts)));

          node.history = merged;

          if(merged.length){
            const latest = merged[0];
            if(!node.last || String(latest.ts) > String(node.last.ts)){
              node.last = latest;
            }
          }
        }
      }
      return store;
    }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw){
          return normalizeAndDedupeStore({ activeProfile: "Asim", data: { Asim: {}, Marwa: {} } });
        }
        const obj = JSON.parse(raw);
        if(!obj.data) obj.data = { Asim: {}, Marwa: {} };
        if(!obj.data.Asim) obj.data.Asim = {};
        if(!obj.data.Marwa) obj.data.Marwa = {};
        if(!obj.activeProfile) obj.activeProfile = "Asim";
        return normalizeAndDedupeStore(obj);
      } catch {
        return normalizeAndDedupeStore({ activeProfile: "Asim", data: { Asim: {}, Marwa: {} } });
      }
    }

    function saveStore(store){
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
    }

    function formatLine(entry){
      const parts = [];
      parts.push(entry.cartoonLabel);
      if(entry.seriesLabel) parts.push(entry.seriesLabel);

      if(entry.type === "season"){
        parts.push(entry.seasonOrMovie);
        parts.push(`EP ${entry.num}`);
      } else {
        parts.push("MOVIES");
        parts.push(`M${entry.num}`);
      }
      return parts.join(" ");
    }

    function upsertEntry(store, profile, entry){
      const node = ensurePath(store, profile, entry.cartoonLabel);

      entry.seriesLabel = normalizeSeriesLocal(entry.seriesLabel);

      if(!node.last || String(entry.ts) >= String(node.last.ts)){
        node.last = entry;
      }

      const keySeries = entry.seriesLabel || null;

      const idx = node.history.findIndex(h =>
        (h.type === entry.type) &&
        (h.seasonOrMovie === entry.seasonOrMovie) &&
        (normalizeSeriesLocal(h.seriesLabel) === keySeries)
      );

      if(idx >= 0){
        const old = node.history[idx];
        if(!old || String(entry.ts) >= String(old.ts)){
          node.history[idx] = entry;
        }
      } else {
        node.history.unshift(entry);
      }

      node.history.sort((a,b) => String(b.ts).localeCompare(String(a.ts)));
    }

    function supabaseEnabled(){
      return !!(SUPABASE_URL && SUPABASE_ANON_KEY && supabaseClient);
    }

    async function sbUpsertProgress(row){
      const room = getRoomCode();
      if(!room) return { ok: false, skipped: true };

      const cloudSeries = (row.series_label == null || String(row.series_label).trim() === "")
        ? "-"
        : String(row.series_label);

      const payload = {
        room_code: room,
        profile: row.profile,
        cartoon_label: row.cartoon_label,
        series_label: cloudSeries,
        type: row.type,
        season_or_movie: row.season_or_movie,
        num: Number(row.num) || 0,
        ts: row.ts
      };

      const { error } = await supabaseClient
        .from(TABLE_NAME)
        .upsert(payload, {
          onConflict: "room_code,profile,cartoon_label,series_label,type,season_or_movie"
        });

      if(error){
        console.error("Cloud upsert error:", error);
        return { ok: false, error: error.message || "Cloud upsert failed" };
      }
      return { ok: true };
    }

    async function sbFetchProgress(room, profile, limit = 250){
      if(!room) return { ok: false, skipped: true, rows: [] };

      const { data, error } = await supabaseClient
        .from(TABLE_NAME)
        .select("room_code,profile,cartoon_label,series_label,type,season_or_movie,num,ts")
        .eq("room_code", room)
        .eq("profile", profile)
        .order("ts", { ascending: false })
        .limit(limit);

      if(error){
        console.error("Cloud fetch error:", error);
        return { ok: false, error: error.message || "Cloud fetch failed", rows: [] };
      }
      return { ok: true, rows: data || [] };
    }

    function initTracker(){
      const profileSeg = document.getElementById("profileSeg");
      const modeSeg = document.getElementById("modeSeg");

      const savePanel = document.getElementById("savePanel");
      const recentPanel = document.getElementById("recentPanel");

      const cartoonSelect = document.getElementById("cartoonSelect");
      const seriesField = document.getElementById("seriesField");
      const seriesSelect = document.getElementById("seriesSelect");
      const typeSelect = document.getElementById("typeSelect");
      const seasonLabel = document.getElementById("seasonLabel");
      const seasonOrMovieSelect = document.getElementById("seasonOrMovieSelect");
      const numSelect = document.getElementById("numSelect");

      const saveBtn = document.getElementById("saveBtn");
      const saveHint = document.getElementById("saveHint");

      const recentCartoonSelect = document.getElementById("recentCartoonSelect");
      const recentInfo = document.getElementById("recentInfo");
      const activityList = document.getElementById("activityList");

      const roomInput = document.getElementById("roomInput");
      const roomSaveBtn = document.getElementById("roomSaveBtn");
      const roomStatus = document.getElementById("roomStatus");

      if(!profileSeg || !modeSeg) return;

      let store = loadStore();
      saveStore(store);

      let activeProfile = store.activeProfile || "Asim";
      let activeMode = "save";
      let pollTimer = null;
      let lastCloudOk = true;

      function vib(){ if(navigator.vibrate) navigator.vibrate(16); }

      function updateRoomStatus(msg){
        if(roomStatus) roomStatus.textContent = msg || "";
      }

      function refreshRoomUI(){
        const room = getRoomCode();
        if(roomInput) roomInput.value = room;

        if(!room){
          setSyncStatus("Sync: OFF (local only)");
          updateRoomStatus("Sync is OFF (no room code). Local save only.");
          return;
        }

        if(!supabaseEnabled()){
          setSyncStatus(`Sync: OFF (Room: ${room})`);
          updateRoomStatus(`Room: ${room} â†’ Sync OFF (Supabase not available).`);
          return;
        }

        setSyncStatus(`Sync: ON (Room: ${room})`);
        updateRoomStatus(`Room: ${room} â†’ Sync ON`);
      }

      function setProfileUI(){
        [...profileSeg.querySelectorAll("button")].forEach(b => {
          b.classList.toggle("active", b.dataset.profile === activeProfile);
        });
      }

      function setModeUI(){
        [...modeSeg.querySelectorAll("button")].forEach(b => {
          b.classList.toggle("active", b.dataset.mode === activeMode);
        });

        if(activeMode === "save"){
          savePanel.classList.remove("hidden");
          recentPanel.classList.add("hidden");
        } else {
          savePanel.classList.add("hidden");
          recentPanel.classList.remove("hidden");
          renderRecent();
        }
      }

      function cartoonsList(){ return Object.keys(MODEL); }
      function getCartoonCfg(name){ return MODEL[name]; }

      function fillCartoonSelects(){
        const opts = cartoonsList().map(c => `<option value="${c}">${c}</option>`).join("");
        cartoonSelect.innerHTML = opts;
        recentCartoonSelect.innerHTML = opts;
      }

      function fillSeries(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(!cfg || !cfg.hasSeries){
          seriesField.classList.add("hidden");
          seriesSelect.innerHTML = "";
          return;
        }
        seriesField.classList.remove("hidden");
        seriesSelect.innerHTML = cfg.series.map(s => `<option value="${s}">${s}</option>`).join("");
      }

      function fillSeasonOrMovie(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        const type = typeSelect.value;

        if(type === "movie"){
          seasonLabel.textContent = "Movies";
          seasonOrMovieSelect.innerHTML = `<option value="Movies">Movies</option>`;
          return;
        }

        seasonLabel.textContent = "Season";

        let seasons = [];
        if(cfg.hasSeries){
          const s = seriesSelect.value;
          seasons = (cfg.seasonsBySeries && cfg.seasonsBySeries[s]) ? cfg.seasonsBySeries[s] : [];
        } else {
          seasons = cfg.seasons || [];
        }

        seasonOrMovieSelect.innerHTML = seasons.map(x => `<option value="${x}">${x}</option>`).join("");
      }

      function fillEpisodeDropdown(max = 100){
        let html = "";
        for(let i=1; i<=max; i++){
          html += `<option value="${i}">${i}</option>`;
        }
        numSelect.innerHTML = html;
        numSelect.value = "1";
      }

      function currentKeyLabels(){
        const cfg = getCartoonCfg(cartoonSelect.value);
        const cartoonLabel = cfg.label;

        const type = typeSelect.value;
        let seriesLabel = null;

        if(cfg.hasSeries){
          const s = seriesSelect.value;
          seriesLabel = (s === "Classic") ? "CL" :
                        (s === "Alien Force") ? "AF" :
                        (s === "Ultimate Alien") ? "UA" :
                        (s === "Omniverse") ? "OV" : s;
        }

        const seasonOrMovie = seasonOrMovieSelect.value;
        return { cartoonLabel, seriesLabel, type, seasonOrMovie };
      }

      function updateSaveHintForCartoon(){
        store = loadStore();
        const cfg = getCartoonCfg(cartoonSelect.value);
        const cartoonLabel = cfg.label;
        const node = ensurePath(store, activeProfile, cartoonLabel);

        if(node.last){
          saveHint.textContent = `Last Watched: ${formatLine(node.last)} (${displayLocal(node.last.ts)})`;
        } else {
          saveHint.textContent = "No activity yet for this cartoon.";
        }
      }

      function renderRecent(){
        store = loadStore();
        const cartoonName = recentCartoonSelect.value;
        const cfg = getCartoonCfg(cartoonName);
        const cartoonLabel = cfg.label;

        const node = ensurePath(store, activeProfile, cartoonLabel);
        const list = node.history || [];

        if(list.length === 0){
          recentInfo.textContent = "No activity yet.";
          activityList.innerHTML = "";
          return;
        }

        recentInfo.textContent = `Showing all activity for ${cartoonLabel} (${activeProfile})`;
        activityList.innerHTML = list
          .map(item => `
            <div class="activity-item">
              <div>${formatLine(item)}</div>
              <div class="right">${displayLocal(item.ts)}</div>
            </div>
          `)
          .join("");
      }

      async function pollFromCloud(){
        const room = getRoomCode();
        if(!room || !supabaseEnabled()) return;

        const res = await sbFetchProgress(room, activeProfile, 250);
        if(!res.ok){
          if(lastCloudOk){
            updateRoomStatus(`Room: ${room} â†’ Sync ON, but fetch failed. (Will keep trying)`);
          }
          lastCloudOk = false;
          return;
        }

        lastCloudOk = true;

        store = loadStore();

        for(const r of res.rows){
          const entry = {
            cartoonLabel: r.cartoon_label,
            seriesLabel: normalizeSeriesLocal(r.series_label),
            type: r.type,
            seasonOrMovie: r.season_or_movie,
            num: Number(r.num) || 1,
            ts: r.ts
          };
          upsertEntry(store, activeProfile, entry);
        }

        store = normalizeAndDedupeStore(store);
        saveStore(store);

        updateSaveHintForCartoon();
        if(activeMode === "recent") renderRecent();
        refreshRoomUI();
      }

      function startPolling(){
        stopPolling();
        const room = getRoomCode();
        if(!room || !supabaseEnabled()) return;

        pollTimer = setInterval(() => {
          pollFromCloud().catch(() => {});
        }, SYNC_POLL_MS);

        pollFromCloud().catch(() => {});
      }

      function stopPolling(){
        if(pollTimer){
          clearInterval(pollTimer);
          pollTimer = null;
        }
      }

      async function doSave(){
        vib();
        store = loadStore();

        const cur = currentKeyLabels();
        const num = Math.max(1, Math.min(100, Number(numSelect.value) || 1));

        const entry = {
          cartoonLabel: cur.cartoonLabel,
          seriesLabel: normalizeSeriesLocal(cur.seriesLabel),
          type: cur.type,
          seasonOrMovie: cur.seasonOrMovie,
          num,
          ts: nowISO()
        };

        upsertEntry(store, activeProfile, entry);
        store = normalizeAndDedupeStore(store);
        saveStore(store);

        saveHint.textContent = `Saved: ${formatLine(entry)} (${displayLocal(entry.ts)})`;

        const room = getRoomCode();
        if(!room || !supabaseEnabled()){
          return;
        }

        const push = await sbUpsertProgress({
          profile: activeProfile,
          cartoon_label: entry.cartoonLabel,
          series_label: entry.seriesLabel || "-",
          type: entry.type,
          season_or_movie: entry.seasonOrMovie,
          num: entry.num,
          ts: entry.ts
        });

        if(push.ok){
          pollFromCloud().catch(() => {});
        } else {
          saveHint.textContent = `Saved locally. (Cloud failed: ${push.error || "blocked"})`;
        }
      }

      fillCartoonSelects();
      fillSeries();
      fillSeasonOrMovie();
      fillEpisodeDropdown(100);

      setProfileUI();
      setModeUI();

      recentCartoonSelect.value = cartoonSelect.value;

      refreshRoomUI();
      updateSaveHintForCartoon();
      startPolling();

      profileSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        vib();

        activeProfile = btn.dataset.profile;

        store = loadStore();
        store.activeProfile = activeProfile;
        saveStore(store);

        setProfileUI();
        updateSaveHintForCartoon();
        if(activeMode === "recent") renderRecent();
        startPolling();
      });

      modeSeg.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        vib();
        activeMode = btn.dataset.mode;
        setModeUI();
      });

      cartoonSelect.addEventListener("change", () => {
        fillSeries();
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(!cfg.hasMovies) typeSelect.value = "season";

        fillSeasonOrMovie();
        updateSaveHintForCartoon();

        recentCartoonSelect.value = cartoonSelect.value;
        if(activeMode === "recent") renderRecent();
      });

      seriesSelect.addEventListener("change", () => {
        fillSeasonOrMovie();
        updateSaveHintForCartoon();
      });

      typeSelect.addEventListener("change", () => {
        const cfg = getCartoonCfg(cartoonSelect.value);
        if(typeSelect.value === "movie" && !cfg.hasMovies) typeSelect.value = "season";
        fillSeasonOrMovie();
        updateSaveHintForCartoon();
      });

      seasonOrMovieSelect.addEventListener("change", () => {
        updateSaveHintForCartoon();
      });

      saveBtn.addEventListener("click", () => { doSave().catch(() => {}); });

      recentCartoonSelect.addEventListener("change", renderRecent);

      if(roomSaveBtn && roomInput){
        roomSaveBtn.addEventListener("click", () => {
          vib();
          const code = (roomInput.value || "").trim();
          setRoomCode(code);
          refreshRoomUI();
          startPolling();
        });
      }

      if(roomInput){
        roomInput.addEventListener("keydown", (e) => {
          if(e.key === "Enter"){
            e.preventDefault();
            if(roomSaveBtn) roomSaveBtn.click();
          }
        });
      }
    }

    window.addEventListener("load", () => {
      initTracker();
    });
  </script>
</body>
</html>
